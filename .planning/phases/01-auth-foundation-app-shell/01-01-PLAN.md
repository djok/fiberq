---
phase: 01-auth-foundation-app-shell
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - web/package.json
  - web/next.config.ts
  - web/postcss.config.mjs
  - web/tsconfig.json
  - web/src/app/layout.tsx
  - web/src/app/globals.css
  - web/src/auth.ts
  - web/src/auth.config.ts
  - web/src/proxy.ts
  - web/src/types/next-auth.d.ts
  - web/src/lib/utils.ts
  - web/src/lib/roles.ts
  - web/src/lib/api.ts
  - web/src/app/api/auth/[...nextauth]/route.ts
  - web/src/i18n/routing.ts
  - web/src/i18n/navigation.ts
  - web/src/i18n/request.ts
  - web/src/messages/en.json
  - web/src/messages/bg.json
  - web/Dockerfile
  - web/.env.local
  - server/nginx/nginx.conf
  - server/api/main.py
  - server/docker-compose.yml
autonomous: true
user_setup:
  - service: zitadel
    why: "Next.js needs its own Zitadel application for OIDC"
    env_vars:
      - name: AUTH_ZITADEL_ID
        source: "Zitadel Console -> Project -> Applications -> Create Web Application -> Client ID"
      - name: AUTH_ZITADEL_SECRET
        source: "Zitadel Console -> same Application -> Client Secret (generate random string for Auth.js session encryption)"
      - name: ZITADEL_ISSUER
        source: "Your Zitadel instance URL (e.g., https://your-instance.zitadel.cloud)"
    dashboard_config:
      - task: "Create a Web application in the existing Zitadel project"
        location: "Zitadel Console -> Project -> Applications -> New -> Web"
      - task: "Set redirect URI to http://localhost:3000/api/auth/callback/zitadel (dev) and https://yourdomain/api/auth/callback/zitadel (prod)"
        location: "Zitadel Console -> Application -> Redirect Settings"
      - task: "Enable 'Assert Roles on Authentication' in Project settings"
        location: "Zitadel Console -> Project -> General"
      - task: "Enable 'User Roles Inside ID Token' in Application Token Settings"
        location: "Zitadel Console -> Application -> Token Settings"
      - task: "Set post-logout redirect URI to http://localhost:3000 (dev) and https://yourdomain (prod)"
        location: "Zitadel Console -> Application -> Redirect Settings"

must_haves:
  truths:
    - "Next.js application starts and serves pages at localhost:3000"
    - "Unauthenticated request to any page redirects to Zitadel login"
    - "After Zitadel login, user lands on an authenticated page (not a redirect loop)"
    - "Auth session contains raw Zitadel access_token and user roles (not NextAuth JWE)"
    - "FastAPI CORS allows credentialed requests from the Next.js origin"
    - "Nginx routes /api/auth/* to Next.js and /api/* to FastAPI without conflict"
  artifacts:
    - path: "web/src/auth.ts"
      provides: "Auth.js configuration with Zitadel provider, JWT/session callbacks"
      exports: ["handlers", "auth", "signIn", "signOut"]
    - path: "web/src/proxy.ts"
      provides: "Request proxy composing auth check then i18n routing"
      contains: "auth check before intlMiddleware"
    - path: "web/src/app/api/auth/[...nextauth]/route.ts"
      provides: "Auth.js API route handler"
      exports: ["GET", "POST"]
    - path: "web/src/lib/api.ts"
      provides: "Server-side fetch helper forwarding raw Zitadel JWT to FastAPI"
      contains: "session.accessToken"
    - path: "web/src/lib/roles.ts"
      provides: "Role constants and nav item filtering"
      exports: ["ROLES", "NAV_ITEMS", "filterNavByRole"]
    - path: "web/src/i18n/routing.ts"
      provides: "Locale configuration (en, bg)"
      contains: "defineRouting"
    - path: "web/Dockerfile"
      provides: "Multi-stage standalone Docker build"
      contains: "COPY --from=builder"
    - path: "server/nginx/nginx.conf"
      provides: "Updated Nginx routing /api/auth/ to web, / to web"
      contains: "proxy_pass http://web:3000"
    - path: "server/docker-compose.yml"
      provides: "web service added to compose"
      contains: "service: web"
  key_links:
    - from: "web/src/auth.ts"
      to: "Zitadel OIDC"
      via: "next-auth Zitadel provider with offline_access scope"
      pattern: "offline_access"
    - from: "web/src/auth.ts"
      to: "web/src/lib/api.ts"
      via: "session.accessToken (raw Zitadel JWT, not JWE)"
      pattern: "token\\.accessToken = account\\.access_token"
    - from: "web/src/proxy.ts"
      to: "web/src/auth.ts"
      via: "auth() check before i18n middleware"
      pattern: "auth.*intlMiddleware"
    - from: "server/nginx/nginx.conf"
      to: "web container"
      via: "/api/auth/ location block before /api/ block"
      pattern: "location /api/auth/"
---

<objective>
Bootstrap the Next.js 16 application with Auth.js v5 Zitadel integration, i18n foundation, and infrastructure updates (Nginx, CORS, Docker Compose).

Purpose: This is the foundation everything else renders within. Without working auth and correct token forwarding, no subsequent feature can function. The infrastructure changes (Nginx routing, CORS fix, Docker web service) are prerequisites for the app to run in the existing stack.

Output: A running Next.js app that authenticates via Zitadel, correctly forwards tokens to FastAPI, and integrates into the Docker Compose stack.
</objective>

<execution_context>
@/home/rosen/.claude/get-shit-done/workflows/execute-plan.md
@/home/rosen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-auth-foundation-app-shell/01-RESEARCH.md
@.planning/phases/01-auth-foundation-app-shell/01-CONTEXT.md
@server/nginx/nginx.conf
@server/docker-compose.yml
@server/api/main.py
@server/api/config.py
@server/api/auth/zitadel.py
@server/api/auth/models.py
@server/api/auth/roles.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Next.js 16 project with all dependencies and core configuration</name>
  <files>
    web/package.json
    web/next.config.ts
    web/postcss.config.mjs
    web/tsconfig.json
    web/src/app/layout.tsx
    web/src/app/globals.css
    web/src/lib/utils.ts
    web/src/types/next-auth.d.ts
    web/src/i18n/routing.ts
    web/src/i18n/navigation.ts
    web/src/i18n/request.ts
    web/src/messages/en.json
    web/src/messages/bg.json
    web/Dockerfile
    web/.env.local
  </files>
  <action>
    **Step 1: Scaffold Next.js project.**
    Run `npx create-next-app@latest web --typescript --app --tailwind --turbopack --no-eslint --no-import-alias` from the repo root `/home/rosen/fiberq/`. If the interactive prompt asks questions, use: TypeScript=Yes, Tailwind=Yes, App Router=Yes, src/ directory=Yes. After scaffolding, `cd web` for all subsequent commands.

    **Step 2: Install dependencies.**
    ```bash
    npm install next-auth@beta next-intl next-themes lucide-react
    ```

    **Step 3: Initialize shadcn/ui.**
    Run `npx shadcn@latest init` -- select default style, CSS variables=yes. This creates `components.json` and `src/lib/utils.ts` with the `cn()` helper. If interactive prompts block, create `components.json` manually with style "new-york", tailwindCss, and aliases `@/components`, `@/lib`.

    **Step 4: Add required shadcn/ui components.**
    ```bash
    npx shadcn@latest add sidebar button avatar dropdown-menu skeleton separator sheet tooltip
    ```
    This generates files in `src/components/ui/`.

    **Step 5: Configure `next.config.ts`.**
    Use `createNextIntlPlugin` from `next-intl/plugin` wrapping the config. Set `output: "standalone"` for Docker builds. Point the intl plugin to `./src/i18n/request.ts`.

    **Step 6: Set up i18n files.**
    Create `src/i18n/routing.ts` with `defineRouting({ locales: ["en", "bg"], defaultLocale: "en" })`.
    Create `src/i18n/navigation.ts` with `createNavigation(routing)` exporting `Link, redirect, usePathname, useRouter, getPathname`.
    Create `src/i18n/request.ts` with `getRequestConfig` that loads locale messages dynamically.

    **Step 7: Create translation files.**
    Create `src/messages/en.json` and `src/messages/bg.json` with keys for: `nav` (dashboard, projects, users, profile, logout), `profile` (title, name, email, role, projects, lastLogin, editProfile, noProjects), `common` (loading, error, language, appName="FiberQ"), `auth` (signIn, signOut, sessionExpired), `roles` (admin, project_manager, engineer, field_worker). Bulgarian translations should be actual Bulgarian text, not placeholders.

    **Step 8: Create Auth.js type augmentation.**
    Create `src/types/next-auth.d.ts` extending `Session` with `accessToken?: string` and `user.roles: string[]`. Extend `JWT` with `accessToken`, `refreshToken`, `idToken`, `expiresAt`, `roles`, `error` fields. Follow the exact pattern from the research doc.

    **Step 9: Create root layout.**
    Update `src/app/layout.tsx` to be the bare root layout with `<html>` and `<body>` tags. DO NOT add providers here yet (they go in the `[locale]/layout.tsx` in Plan 02). Just set `lang` attribute and include the globals.css import. Add `suppressHydrationWarning` to `<html>` for next-themes compatibility.

    **Step 10: Create `.env.local`.**
    Create `web/.env.local` with placeholder values (commented explanations):
    ```
    # Zitadel OIDC
    AUTH_ZITADEL_ID=your_client_id_here
    AUTH_ZITADEL_SECRET=your_random_secret_here
    ZITADEL_ISSUER=https://your-instance.zitadel.cloud
    AUTH_SECRET=generate_with_openssl_rand_base64_32
    AUTH_TRUST_HOST=true

    # Internal API URL (Docker network)
    INTERNAL_API_URL=http://api:8000
    # For local dev without Docker:
    # INTERNAL_API_URL=http://localhost:8000

    # App URL
    NEXTAUTH_URL=http://localhost:3000
    ```

    **Step 11: Create Dockerfile.**
    Multi-stage build: deps (node:20-alpine, npm ci), builder (copy source, npm run build), runner (node:20-alpine, copy standalone + static + public, run as non-root nextjs user on port 3000). Follow the exact pattern from research. Do NOT forget to copy `.next/static` and `public/` into the standalone output.

    **Step 12: Clean up scaffolding.**
    Remove the default Next.js boilerplate page content from `src/app/page.tsx` (replace with a simple redirect or placeholder). Remove any default favicon if it conflicts.
  </action>
  <verify>
    Run `cd /home/rosen/fiberq/web && npm run build` -- should complete without errors.
    Run `npm run dev` and confirm `http://localhost:3000` serves a page (even if it redirects or shows placeholder).
    Verify `src/components/ui/sidebar.tsx` exists (shadcn/ui sidebar installed).
    Verify `src/i18n/routing.ts` exists with `locales: ["en", "bg"]`.
    Verify `next.config.ts` has `output: "standalone"` and `createNextIntlPlugin`.
  </verify>
  <done>
    Next.js 16 project exists at `web/` with all dependencies installed, shadcn/ui components generated, i18n routing configured for en/bg, translation files populated, Dockerfile created, and `npm run build` succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure Auth.js with Zitadel, proxy.ts, API client, and roles</name>
  <files>
    web/src/auth.ts
    web/src/auth.config.ts
    web/src/proxy.ts
    web/src/app/api/auth/[...nextauth]/route.ts
    web/src/lib/api.ts
    web/src/lib/roles.ts
  </files>
  <action>
    **Step 1: Create `src/auth.config.ts`.**
    This is the edge-compatible auth config (no database adapter, no Node.js APIs). Export `authConfig` with:
    - `pages: {}` (use default Auth.js pages -- Zitadel handles the actual login UI)
    - `providers: []` (empty here, full providers in auth.ts)
    - `callbacks: { authorized({ auth }) { return !!auth; } }` -- simple auth check for proxy.ts

    **Step 2: Create `src/auth.ts`.**
    Full Auth.js configuration. Import `NextAuth` from `next-auth`, import `Zitadel` from `next-auth/providers/zitadel`.

    Provider config:
    - `issuer: process.env.ZITADEL_ISSUER`
    - `clientId: process.env.AUTH_ZITADEL_ID!`
    - `clientSecret: process.env.AUTH_ZITADEL_SECRET!`
    - `authorization.params.scope`: `"openid profile email offline_access urn:zitadel:iam:org:projects:roles"` -- all five scopes on one string, space-separated.

    Session strategy: `"jwt"`.

    JWT callback:
    - On initial sign-in (`if (account)`): Store `account.access_token`, `account.refresh_token`, `account.id_token`, `account.expires_at` on the token. Extract roles from the access_token or id_token using the same claim key pattern as the existing FastAPI backend (`urn:zitadel:iam:org:project:roles` and `urn:zitadel:iam:org:project:{id}:roles`). To extract roles, decode the id_token (or access_token) claims -- Auth.js passes the raw `account.id_token` as a string; use a base64 decode of the payload segment to read claims without crypto verification (the token is already verified by the OIDC flow). Store extracted roles on `token.roles`.
    - On subsequent calls: Check if `token.expiresAt` has passed. If expired, attempt refresh using `token.refreshToken` by POSTing to the Zitadel token endpoint (`${process.env.ZITADEL_ISSUER}/oauth/v2/token` with `grant_type=refresh_token`). On success, update `token.accessToken`, `token.refreshToken`, `token.expiresAt`. On failure, set `token.error = "RefreshTokenError"`.

    Session callback:
    - Set `session.accessToken = token.accessToken` (the RAW Zitadel JWT).
    - Set `session.user.roles = token.roles ?? []`.
    - Set `session.user.name`, `session.user.email`, `session.user.image` from token (Auth.js populates these from OIDC profile).
    - If `token.error`, set `session.error = token.error`.

    Export `{ handlers, auth, signIn, signOut }`.

    CRITICAL: The `session.accessToken` MUST be the raw Zitadel-issued JWT, NOT the NextAuth encrypted session token. This is what gets sent to FastAPI. FastAPI validates it against Zitadel's JWKS. If you forward the NextAuth JWE instead, FastAPI will reject every request with "Invalid token header".

    **Step 3: Create `src/app/api/auth/[...nextauth]/route.ts`.**
    ```typescript
    import { handlers } from "@/auth";
    export const { GET, POST } = handlers;
    ```

    **Step 4: Create `src/proxy.ts`.**
    Compose auth + i18n in correct order (auth FIRST, then i18n).

    Logic:
    1. If path starts with `/api/auth` -- return `NextResponse.next()` (skip auth for auth callbacks).
    2. If path starts with `/api/` -- return `NextResponse.next()` (skip for API routes).
    3. If path matches static files (`_next`, `favicon.ico`, etc.) -- return `NextResponse.next()`.
    4. Check auth via `auth()` from auth.ts. If no session, redirect to `/api/auth/signin/zitadel` (direct Zitadel redirect per user decision -- no intermediate landing page).
    5. If authenticated, run `intlMiddleware(request)` from next-intl.

    Matcher config: `/((?!_next|_vercel|.*\\..*).*)` -- matches all non-static paths.

    CRITICAL ordering: Auth check runs BEFORE i18n middleware. If reversed, unauthenticated users get locale-redirected instead of login-redirected, causing redirect loops (Pitfall #7).

    **Step 5: Create `src/lib/api.ts`.**
    Server-side fetch helper:
    - `apiFetch(path: string, options?: RequestInit)` -- async function.
    - Gets session via `auth()` from `@/auth`.
    - If no `session?.accessToken`, throws "Not authenticated".
    - Fetches from `${process.env.INTERNAL_API_URL || "http://api:8000"}${path}`.
    - Sets `Authorization: Bearer ${session.accessToken}` header (raw Zitadel JWT).
    - Sets `Content-Type: application/json`.
    - On non-ok response, throws with status code.
    - Returns parsed JSON.

    **Step 6: Create `src/lib/roles.ts`.**
    Define role constants matching the existing backend (`server/api/auth/roles.py`):
    - `ROLES = { ADMIN: "admin", PROJECT_MANAGER: "project_manager", ENGINEER: "engineer", FIELD_WORKER: "field_worker" }` -- Note: add `project_manager` role per PROJECT.md "4 roles instead of 3" decision, even though the backend currently has 3. The frontend defines it; the backend will be extended in Phase 2.
    - `type Role` union type.
    - `NavItem` interface with `titleKey` (i18n key), `href`, `icon` (Lucide icon name), `requiredRoles?: Role[]`.
    - `NAV_ITEMS` array:
      - Dashboard: `/dashboard`, LayoutDashboard icon, no role restriction
      - Projects: `/projects`, FolderKanban icon, no role restriction
      - Users: `/users`, Users icon, `requiredRoles: ["admin"]`
      - Profile: `/profile`, UserCircle icon, no role restriction
    - `filterNavByRole(items, userRoles)` function: returns items where `requiredRoles` is empty OR at least one role matches.
    - `getDefaultRedirect(roles)` function: if `roles.includes("admin")` return `/users`, else return `/projects`. (Per user decision: admin goes to User Management, others to Projects.)
  </action>
  <verify>
    Run `cd /home/rosen/fiberq/web && npx tsc --noEmit` -- should have no type errors in auth.ts, proxy.ts, api.ts, roles.ts.
    Verify `src/auth.ts` contains `account.access_token` (not JWE forwarding).
    Verify `src/proxy.ts` checks auth BEFORE calling intlMiddleware.
    Verify `src/lib/roles.ts` exports `filterNavByRole` and `NAV_ITEMS`.
    Verify `src/app/api/auth/[...nextauth]/route.ts` exports GET and POST.
  </verify>
  <done>
    Auth.js fully configured with Zitadel provider (PKCE + offline_access), raw token forwarding in JWT/session callbacks, silent token refresh, proxy.ts composing auth-then-i18n, API client forwarding Bearer token, and role utilities ready for sidebar filtering.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update infrastructure -- Nginx, CORS fix, Docker Compose web service</name>
  <files>
    server/nginx/nginx.conf
    server/api/main.py
    server/docker-compose.yml
  </files>
  <action>
    **Step 1: Update `server/nginx/nginx.conf`.**
    Add upstream for web container: `upstream web { server web:3000; }`.
    Add `/api/auth/` location block BEFORE the existing `/api/` block (Nginx processes first match for prefix locations, but longer prefix takes priority -- still, place it before for clarity):
    ```nginx
    location /api/auth/ {
        proxy_pass http://web:3000/api/auth/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    ```
    Update the existing `/api/` block -- no changes needed (it already proxies to FastAPI).
    Replace the catch-all `location /` block: instead of serving static files, proxy to the web container:
    ```nginx
    location / {
        proxy_pass http://web:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header x-middleware-subrequest "";
    }
    ```
    The `x-middleware-subrequest` header stripping is defense-in-depth for CVE-2025-29927 (already fixed in Next.js 16 but good practice).

    Keep the existing `/health` and `/storage/photos/` blocks unchanged.

    **Step 2: Fix CORS in `server/api/main.py`.**
    The existing code has `allow_origins=["*"]` with `allow_credentials=True` -- this is spec-invalid (Pitfall #2).
    Change to use an environment variable for allowed origins:
    ```python
    allowed_origins = os.environ.get("CORS_ORIGINS", "http://localhost:3000").split(",")
    app.add_middleware(
        CORSMiddleware,
        allow_origins=allowed_origins,
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    ```
    Note: In production behind Nginx on the same domain, CORS is not triggered (same-origin). But for local dev (Next.js on :3000, FastAPI on :8000), explicit origins are needed. Add `CORS_ORIGINS` to the api service environment in docker-compose.yml set to `http://localhost:3000`.

    **Step 3: Update `server/docker-compose.yml`.**
    Add a `web` service:
    ```yaml
    web:
      build:
        context: ../web
        dockerfile: Dockerfile
      container_name: fiberq-web
      environment:
        AUTH_ZITADEL_ID: ${AUTH_ZITADEL_ID:?AUTH_ZITADEL_ID is required}
        AUTH_ZITADEL_SECRET: ${AUTH_ZITADEL_SECRET:?AUTH_ZITADEL_SECRET is required}
        ZITADEL_ISSUER: ${ZITADEL_ISSUER:?ZITADEL_ISSUER is required}
        AUTH_SECRET: ${AUTH_SECRET:?AUTH_SECRET is required}
        AUTH_TRUST_HOST: "true"
        INTERNAL_API_URL: http://api:8000
        NEXTAUTH_URL: ${NEXTAUTH_URL:-http://localhost:3000}
      depends_on:
        api:
          condition: service_healthy
      healthcheck:
        test: ["CMD", "node", "-e", "fetch('http://localhost:3000').then(r => process.exit(r.ok ? 0 : 1)).catch(() => process.exit(1))"]
        interval: 15s
        timeout: 5s
        retries: 3
        start_period: 15s
      restart: unless-stopped
    ```
    Update the `nginx` service to depend on both `api` (existing) and `web`:
    ```yaml
    nginx:
      depends_on:
        api:
          condition: service_healthy
        web:
          condition: service_healthy
    ```
    Add `CORS_ORIGINS: http://localhost:3000` to the `api` service environment section.
  </action>
  <verify>
    Run `cd /home/rosen/fiberq/server && docker compose config --quiet` -- should validate without errors (checks YAML syntax and variable references).
    Verify `server/nginx/nginx.conf` contains `location /api/auth/` block before `location /api/` block.
    Verify `server/nginx/nginx.conf` has `proxy_pass http://web:3000` in the `location /` block.
    Verify `server/api/main.py` no longer has `allow_origins=["*"]` -- should use `allowed_origins` variable.
    Verify `server/docker-compose.yml` has a `web` service with `AUTH_ZITADEL_ID`, `INTERNAL_API_URL` environment variables.
  </verify>
  <done>
    Nginx correctly routes `/api/auth/*` to Next.js and `/api/*` to FastAPI. CORS is fixed with explicit origins. Docker Compose includes the `web` service with all required environment variables and health checks.
  </done>
</task>

</tasks>

<verification>
1. `cd /home/rosen/fiberq/web && npm run build` completes without errors
2. `npx tsc --noEmit` shows no TypeScript errors
3. `cd /home/rosen/fiberq/server && docker compose config --quiet` validates
4. `grep -n "allow_origins" server/api/main.py` shows explicit origins, not `["*"]`
5. `grep -n "location /api/auth/" server/nginx/nginx.conf` shows the auth routing block
6. `grep -n "web:3000" server/nginx/nginx.conf` shows web container proxy
7. `ls web/src/components/ui/sidebar.tsx` confirms shadcn/ui sidebar installed
</verification>

<success_criteria>
- Next.js 16 project builds successfully with standalone output
- Auth.js configured with Zitadel provider, raw token forwarding, and silent refresh
- proxy.ts composes auth-then-i18n without redirect loops
- API client forwards raw Zitadel JWT (not NextAuth JWE) to FastAPI
- Nginx routes auth callbacks to Next.js, API calls to FastAPI
- CORS fixed with explicit allowed origins
- Docker Compose includes web service with health checks
- i18n configured for en/bg with translation files
- All shadcn/ui components (sidebar, button, avatar, etc.) installed
</success_criteria>

<output>
After completion, create `.planning/phases/01-auth-foundation-app-shell/01-01-SUMMARY.md`
</output>
