---
phase: 03-project-management-assignment
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - web/src/app/[locale]/projects/[id]/page.tsx
  - web/src/app/[locale]/projects/_components/project-detail-actions.tsx
  - web/src/app/[locale]/projects/_components/project-members.tsx
  - web/src/app/[locale]/projects/_components/member-combobox.tsx
  - web/src/app/[locale]/projects/_components/edit-project-dialog.tsx
  - web/src/app/[locale]/projects/_actions.ts
autonomous: true

must_haves:
  truths:
    - "User can view project detail page with name, description, status, creation date, and interactive map"
    - "User can view list of members assigned to a project with their names and project roles"
    - "Admin or project manager can assign a user to a project via inline combobox with role selection"
    - "Admin or project manager can remove a member via X button with confirmation dialog"
    - "Admin or project manager can edit project name, description, and status"
    - "Map on detail page shows project extent with interactive controls (unlike non-interactive card mini-maps)"
  artifacts:
    - path: "web/src/app/[locale]/projects/[id]/page.tsx"
      provides: "Server Component detail page fetching project with members and extent"
      contains: "apiFetch"
    - path: "web/src/app/[locale]/projects/_components/project-detail-actions.tsx"
      provides: "Client component bridging detail page with interactive dialogs and member management"
      contains: "useTranslations"
    - path: "web/src/app/[locale]/projects/_components/project-members.tsx"
      provides: "Members list with role badges and X remove button"
      contains: "ProjectMember"
    - path: "web/src/app/[locale]/projects/_components/member-combobox.tsx"
      provides: "Inline Command+Popover combobox for user search and role selection"
      contains: "CommandInput"
    - path: "web/src/app/[locale]/projects/_components/edit-project-dialog.tsx"
      provides: "Dialog for editing project name, description, and status"
      contains: "updateProject"
    - path: "web/src/app/[locale]/projects/_actions.ts"
      provides: "Server Actions for assign, remove, update project"
      contains: "assignMember"
  key_links:
    - from: "web/src/app/[locale]/projects/[id]/page.tsx"
      to: "/projects/{id} API"
      via: "apiFetch('/projects/${id}')"
      pattern: "apiFetch.*projects"
    - from: "web/src/app/[locale]/projects/_components/member-combobox.tsx"
      to: "web/src/app/[locale]/projects/_actions.ts"
      via: "assignMember server action"
      pattern: "assignMember"
    - from: "web/src/app/[locale]/projects/_components/project-members.tsx"
      to: "web/src/app/[locale]/projects/_actions.ts"
      via: "removeMember server action"
      pattern: "removeMember"
---

<objective>
Build the project detail page with interactive map, member list with inline assignment combobox, edit project dialog, and member removal with confirmation.

Purpose: Users need to view project details, see who is assigned, and (if authorized) manage team members directly from the project page.
Output: Project detail page at /projects/[id] with map, info, members section with CRUD, and edit dialog.
</objective>

<execution_context>
@/home/rosen/.claude/get-shit-done/workflows/execute-plan.md
@/home/rosen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-project-management-assignment/03-RESEARCH.md
@.planning/phases/03-project-management-assignment/03-01-SUMMARY.md
@web/src/app/[locale]/users/[id]/page.tsx
@web/src/app/[locale]/users/_components/user-detail-actions.tsx
@web/src/app/[locale]/users/_components/confirm-action-dialog.tsx
@web/src/app/[locale]/projects/_actions.ts
@web/src/types/project.ts
@web/src/app/[locale]/projects/_components/project-mini-map.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add server actions for project update, member assignment, and member removal</name>
  <files>
    web/src/app/[locale]/projects/_actions.ts
  </files>
  <action>
Extend the existing `_actions.ts` (created in Plan 03-02) with additional server actions. The file already has `createProject` and the `ActionResult` type. Add:

1. **updateProject(projectId: number, data: { name?: string, description?: string, status?: string })** -> ActionResult:
   - `apiFetch(\`/projects/${projectId}\`, { method: "PUT", body: JSON.stringify(data) })`
   - revalidatePath for both list and detail pages

2. **assignMember(projectId: number, data: { user_sub: string, user_display_name?: string, user_email?: string, project_role: string })** -> ActionResult:
   - `apiFetch(\`/projects/${projectId}/members\`, { method: "POST", body: JSON.stringify(data) })`
   - revalidatePath for detail page

3. **removeMember(projectId: number, memberId: number)** -> ActionResult:
   - `apiFetch(\`/projects/${projectId}/members/${memberId}\`, { method: "DELETE" })`
   - revalidatePath for detail page

4. **fetchAssignableUsers(projectId: number)** -> ActionResult<AssignableUser[]>:
   - `apiFetch<ApiAssignableUser[]>(\`/projects/${projectId}/assignable-users\`)`
   - Map snake_case response (user_sub, display_name, email) to camelCase AssignableUser type
   - This is a server action that fetches data (not a mutation), used by the combobox to get the user list

All actions follow the same discriminated union pattern: try/catch, return `{ success: true, data }` or `{ success: false, error }`.

Import `AssignableUser` from `@/types/project`.
  </action>
  <verify>
`cd /home/rosen/fiberq/web && npx tsc --noEmit --pretty 2>&1 | grep '_actions' | head -5` -- no type errors in actions file.
`grep -c 'export async function' web/src/app/[locale]/projects/_actions.ts` -- should be 5 (createProject + 4 new).
  </verify>
  <done>
Five server actions exported: createProject, updateProject, assignMember, removeMember, fetchAssignableUsers. All follow discriminated union return pattern with proper error handling and path revalidation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build project detail page with interactive map, info card, members section, and edit dialog</name>
  <files>
    web/src/app/[locale]/projects/[id]/page.tsx
    web/src/app/[locale]/projects/_components/project-detail-actions.tsx
    web/src/app/[locale]/projects/_components/project-members.tsx
    web/src/app/[locale]/projects/_components/member-combobox.tsx
    web/src/app/[locale]/projects/_components/edit-project-dialog.tsx
  </files>
  <action>
1. **Create web/src/app/[locale]/projects/[id]/page.tsx** -- Server Component following Phase 2 user detail page pattern:
   - Import auth, apiFetch, setRequestLocale, getTranslations, notFound, Link, ArrowLeft, Badge, Card components
   - Define `ApiProjectDetail` type matching backend ProjectDetailOut response (id, name, description, status, created_at, created_by_sub, members[{id, user_sub, user_display_name, user_email, project_role, assigned_at}], extent)
   - Define `mapProjectDetail()` function: snake_case -> camelCase for project and nested members
   - Auth check: session required, redirect if not authenticated
   - Fetch project: `apiFetch<ApiProjectDetail>(\`/projects/${id}\`)` -- catch -> notFound()
   - Determine `canManage` boolean: user is admin, or user has "project_manager" global role, or user is a member with project_role "manager" in the fetched data
   - **Layout (two-column on desktop, single column on mobile):**
     - Header: Back link to projects list + project name + status badge
     - `grid gap-6 lg:grid-cols-3`
     - Left column (lg:col-span-2):
       - Map card: Interactive MapLibre map (~300px height). Reuse `ProjectMiniMap` component from Plan 03-02 but pass `interactive={true}` prop (extend the component to accept this). Alternatively create a separate larger map component, but simpler to add an `interactive` prop.
       - Project info card: name, description, status, created date -- read-only display
     - Right column:
       - `<ProjectDetailActions>` client component receiving: project data, members, canManage flag, locale

2. **Create web/src/app/[locale]/projects/_components/project-detail-actions.tsx** -- "use client" component:
   - Props: `{ project: ProjectDetail, canManage: boolean, locale: string }`
   - Use `useTranslations("projects")`
   - Render two cards:
     - **Members card:** `<ProjectMembers members={project.members} projectId={project.id} canManage={canManage} />`
     - **Actions card** (only if canManage):
       - "Edit Project" button -> opens EditProjectDialog
       - Future: could add archive/delete buttons
   - State: `showEditDialog` boolean
   - Include `<EditProjectDialog>` rendered here, controlled by state

3. **Create web/src/app/[locale]/projects/_components/project-members.tsx** -- Members list:
   - Props: `{ members: ProjectMember[], projectId: number, canManage: boolean }`
   - Use `useTranslations("projects")`
   - Card with CardHeader "Members" and CardContent:
     - If canManage: render `<MemberCombobox projectId={projectId} existingMemberSubs={members.map(m => m.userSub)} />` at the top of the card
     - ScrollArea wrapping the member list (for scrolling when many members)
     - Each member row: avatar placeholder (initials circle), display name, email (muted), project role as Badge, and if canManage: X button to remove
     - X button click: opens ConfirmActionDialog (reuse from `@/app/[locale]/users/_components/confirm-action-dialog.tsx` -- import from there)
     - On confirm: call `removeMember(projectId, member.id)` server action, show toast on success/error, router.refresh()
   - Role badge colors: manager = "default" (primary), specialist = "secondary", observer = "outline"
   - Empty members state: "No members assigned" text

4. **Create web/src/app/[locale]/projects/_components/member-combobox.tsx** -- Inline Command+Popover:
   - Props: `{ projectId: number, existingMemberSubs: string[] }`
   - Uses shadcn Command + Popover composition (per user decision: inline combobox, NOT a dialog)
   - On mount or when popover opens: call `fetchAssignableUsers(projectId)` server action to get available users
   - Filter out users already in `existingMemberSubs`
   - Layout: flex row with three elements:
     - Popover trigger button showing selected user name or "Select user..."
     - Select dropdown for project role (Manager / Specialist / Observer), default "specialist"
     - "Add" button to submit
   - Command component inside Popover: CommandInput for search, CommandList with CommandGroup, CommandItem for each user showing display name + email
   - On "Add" click: call `assignMember(projectId, { user_sub, user_display_name, user_email, project_role })` server action
   - On success: toast, router.refresh(), reset selection
   - On error: toast with error
   - Use ChevronsUpDown and Check icons from lucide-react (same as research pattern)

5. **Create web/src/app/[locale]/projects/_components/edit-project-dialog.tsx** -- Edit dialog:
   - Props: `{ project: ProjectDetail, open: boolean, onOpenChange: (open: boolean) => void }`
   - Use shadcn Dialog, react-hook-form + zod
   - Schema: name (string, min 1, max 100), description (string, optional), status (enum of 5 values)
   - Pre-fill form with current project values
   - Fields: Name (Input), Description (Input or Textarea), Status (Select with 5 options)
   - On submit: call `updateProject(project.id, data)` server action
   - On success: toast, close dialog, router.refresh()
   - On error: toast with error message

6. **Update ProjectMiniMap** (from Plan 03-02) -- if Plan 03-02 runs first. Otherwise, this plan creates it as needed. Add an optional `interactive` prop (default false). When `interactive: true`:
   - Set `interactive: true` on MapLibre map options
   - Add navigation control: `map.addControl(new maplibregl.NavigationControl(), "top-right")`
   - This makes the detail page map zoomable/pannable while card mini-maps remain static

**Important patterns to follow:**
- ConfirmActionDialog import: `import { ConfirmActionDialog } from "@/app/[locale]/users/_components/confirm-action-dialog"` -- reuse the existing component from Phase 2
- Server action calls with toast feedback: same pattern as Phase 2 user actions
- `useRouter()` with `router.refresh()` after mutations -- same as Phase 2
- All text via `useTranslations("projects")` -- no hardcoded strings
  </action>
  <verify>
`cd /home/rosen/fiberq/web && npx tsc --noEmit --pretty 2>&1 | head -30` -- no type errors.
`ls web/src/app/[locale]/projects/[id]/page.tsx` -- detail page exists.
`ls web/src/app/[locale]/projects/_components/` -- all component files exist (project-detail-actions, project-members, member-combobox, edit-project-dialog).
`grep 'assignMember' web/src/app/[locale]/projects/_components/member-combobox.tsx` -- server action connected.
`grep 'ConfirmActionDialog' web/src/app/[locale]/projects/_components/project-members.tsx` -- reuses Phase 2 dialog.
`grep 'interactive' web/src/app/[locale]/projects/_components/project-mini-map.tsx` -- interactive prop exists.
  </verify>
  <done>
Project detail page at /projects/[id] shows: interactive map with project extent, project info (name, description, status, created date), members list with role badges. Admin/project managers can: assign users via inline combobox with role selection, remove members with confirmation, edit project name/description/status via dialog. All operations provide toast feedback.
  </done>
</task>

</tasks>

<verification>
1. `cd /home/rosen/fiberq/web && npx tsc --noEmit` -- zero TypeScript errors
2. `cd /home/rosen/fiberq/web && npm run build 2>&1 | tail -5` -- build succeeds
3. Detail page imports and renders all sub-components correctly
4. ConfirmActionDialog reused from Phase 2 users module (not duplicated)
5. All user-facing text uses translation keys from en.json/bg.json
6. Interactive map on detail page has NavigationControl; card mini-maps do not
</verification>

<success_criteria>
Project detail page shows complete project information with interactive map, member list, and management capabilities. Admin and project managers can assign/remove members via inline combobox and edit project properties. Non-managers see read-only view of members and info.
</success_criteria>

<output>
After completion, create `.planning/phases/03-project-management-assignment/03-03-SUMMARY.md`
</output>
