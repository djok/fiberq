---
phase: 03-project-management-assignment
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - web/src/types/project.ts
  - web/src/app/[locale]/projects/page.tsx
  - web/src/app/[locale]/projects/_components/projects-client.tsx
  - web/src/app/[locale]/projects/_components/project-card.tsx
  - web/src/app/[locale]/projects/_components/project-mini-map.tsx
  - web/src/app/[locale]/projects/_components/create-project-dialog.tsx
  - web/src/app/[locale]/projects/_actions.ts
  - web/src/messages/en.json
  - web/src/messages/bg.json
autonomous: true

must_haves:
  truths:
    - "User sees a grid of project cards showing name, status badge, member count, and mini-map"
    - "Admin sees all projects; non-admin users without assignments see empty state message"
    - "User can filter projects by name search, status dropdown, and assigned user"
    - "Admin or Project Manager can open a create project dialog and submit name + description"
    - "Newly created project appears in the grid after submission"
    - "Cards show a PostGIS-driven mini-map when extent data exists, or 'No geographic data' placeholder when it doesn't"
    - "Clicking a project card navigates to the project detail page"
  artifacts:
    - path: "web/src/types/project.ts"
      provides: "ProjectCard and CreateProjectInput TypeScript types"
      contains: "ProjectCard"
    - path: "web/src/app/[locale]/projects/page.tsx"
      provides: "Server Component that fetches projects and passes to client wrapper"
      contains: "apiFetch"
    - path: "web/src/app/[locale]/projects/_components/projects-client.tsx"
      provides: "Client wrapper with card grid, filters, create button, and empty state"
      contains: "ProjectCard"
    - path: "web/src/app/[locale]/projects/_components/project-card.tsx"
      provides: "Individual project card with mini-map, name, status badge, member count"
      contains: "ProjectMiniMap"
    - path: "web/src/app/[locale]/projects/_components/project-mini-map.tsx"
      provides: "Non-interactive MapLibre GL mini-map rendering GeoJSON extent"
      contains: "maplibregl"
    - path: "web/src/app/[locale]/projects/_components/create-project-dialog.tsx"
      provides: "Modal dialog for creating a new project with name and description"
      contains: "createProject"
    - path: "web/src/app/[locale]/projects/_actions.ts"
      provides: "Server Actions for project creation"
      contains: "createProject"
  key_links:
    - from: "web/src/app/[locale]/projects/page.tsx"
      to: "/projects API"
      via: "apiFetch('/projects')"
      pattern: "apiFetch.*projects"
    - from: "web/src/app/[locale]/projects/_components/project-card.tsx"
      to: "web/src/app/[locale]/projects/_components/project-mini-map.tsx"
      via: "Component composition"
      pattern: "ProjectMiniMap"
    - from: "web/src/app/[locale]/projects/_components/create-project-dialog.tsx"
      to: "web/src/app/[locale]/projects/_actions.ts"
      via: "Server Action call"
      pattern: "createProject"
---

<objective>
Build the project list page with card-based layout, PostGIS-driven mini-maps, filtering/search, create project dialog, and role-scoped empty states.

Purpose: Users need a visual overview of their projects with geographic context. This replaces the placeholder projects page with the card grid the user requested.
Output: Fully functional project list page with cards, mini-maps, filters, and create dialog.
</objective>

<execution_context>
@/home/rosen/.claude/get-shit-done/workflows/execute-plan.md
@/home/rosen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-project-management-assignment/03-RESEARCH.md
@.planning/phases/03-project-management-assignment/03-01-SUMMARY.md
@web/src/app/[locale]/users/page.tsx
@web/src/app/[locale]/users/_components/users-client.tsx
@web/src/app/[locale]/users/_components/create-user-dialog.tsx
@web/src/app/[locale]/users/_actions.ts
@web/src/lib/api.ts
@web/src/messages/en.json
@web/src/messages/bg.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies, add shadcn components, create types and server actions</name>
  <files>
    web/src/types/project.ts
    web/src/app/[locale]/projects/_actions.ts
    web/src/messages/en.json
    web/src/messages/bg.json
  </files>
  <action>
1. **Install maplibre-gl** in the web/ directory:
   ```bash
   cd /home/rosen/fiberq/web && npm install maplibre-gl
   ```

2. **Add shadcn/ui components** (command, popover, scroll-area -- needed for this plan and Plan 03-03):
   ```bash
   cd /home/rosen/fiberq/web && npx shadcn@latest add command popover scroll-area --yes
   ```

3. **Create web/src/types/project.ts** with TypeScript types:

```typescript
export type ProjectCard = {
  id: number;
  name: string;
  description: string | null;
  status: string;
  memberCount: number;
  extent: GeoJSON.Geometry | null;
  createdAt: string;
};

export type ProjectDetail = {
  id: number;
  name: string;
  description: string | null;
  status: string;
  createdAt: string;
  createdBySub: string | null;
  members: ProjectMember[];
  extent: GeoJSON.Geometry | null;
};

export type ProjectMember = {
  id: number;
  userSub: string;
  userDisplayName: string | null;
  userEmail: string | null;
  projectRole: string;
  assignedAt: string;
};

export type CreateProjectInput = {
  name: string;
  description?: string;
};

export type AssignableUser = {
  userSub: string;
  displayName: string | null;
  email: string | null;
};
```

Note: GeoJSON types come from the `geojson` package. Check if `@types/geojson` is installed; if not, install it: `cd /home/rosen/fiberq/web && npm install -D @types/geojson`.

4. **Create web/src/app/[locale]/projects/_actions.ts** -- Server Actions following Phase 2 discriminated union pattern:

```typescript
"use server";

import { apiFetch } from "@/lib/api";
import { revalidatePath } from "next/cache";
import type { CreateProjectInput } from "@/types/project";

type ActionResult<T = void> =
  | { success: true; data: T }
  | { success: false; error: string };

export async function createProject(
  data: CreateProjectInput,
): Promise<ActionResult<{ id: number }>> {
  try {
    const result = await apiFetch<{ id: number }>("/projects", {
      method: "POST",
      body: JSON.stringify(data),
    });
    revalidatePath("/[locale]/projects");
    return { success: true, data: result };
  } catch (e) {
    return {
      success: false,
      error: e instanceof Error ? e.message : "Failed to create project",
    };
  }
}
```

5. **Update web/src/messages/en.json** -- Add `projects` key at the top level with these translation keys:

```json
"projects": {
  "title": "Projects",
  "createProject": "Create Project",
  "name": "Project Name",
  "namePlaceholder": "Enter project name",
  "description": "Description",
  "descriptionPlaceholder": "Enter project description",
  "status": "Status",
  "members": "Members",
  "memberCount": "{count} members",
  "noGeographicData": "No geographic data",
  "emptyState": "You have no assigned projects. Contact an administrator.",
  "emptyStateAdmin": "No projects yet. Create your first project.",
  "searchPlaceholder": "Search projects...",
  "filterByStatus": "All statuses",
  "filterByUser": "All users",
  "createSuccess": "Project created successfully",
  "createError": "Failed to create project",
  "statusPlanning": "Planning",
  "statusInProgress": "In Progress",
  "statusCompleted": "Completed",
  "statusPaused": "Paused",
  "statusArchived": "Archived",
  "backToProjects": "Back to projects",
  "projectInfo": "Project Information",
  "createdAt": "Created",
  "editProject": "Edit Project",
  "save": "Save",
  "cancel": "Cancel",
  "addMember": "Add Member",
  "removeMember": "Remove Member",
  "removeMemberConfirm": "Are you sure you want to remove this member from the project?",
  "selectUser": "Select user...",
  "searchUsers": "Search users...",
  "noUsersFound": "No users found.",
  "roleManager": "Manager",
  "roleSpecialist": "Specialist",
  "roleObserver": "Observer",
  "assignSuccess": "Member assigned successfully",
  "removeSuccess": "Member removed successfully",
  "actions": "Actions",
  "editSuccess": "Project updated successfully"
}
```

6. **Update web/src/messages/bg.json** -- Add matching `projects` key with Bulgarian translations:

```json
"projects": {
  "title": "Проекти",
  "createProject": "Създай проект",
  "name": "Име на проекта",
  "namePlaceholder": "Въведете име на проекта",
  "description": "Описание",
  "descriptionPlaceholder": "Въведете описание на проекта",
  "status": "Статус",
  "members": "Членове",
  "memberCount": "{count} членове",
  "noGeographicData": "Няма географски данни",
  "emptyState": "Нямаш назначени проекти. Обърни се към администратор.",
  "emptyStateAdmin": "Все още няма проекти. Създайте първия проект.",
  "searchPlaceholder": "Търсене на проекти...",
  "filterByStatus": "Всички статуси",
  "filterByUser": "Всички потребители",
  "createSuccess": "Проектът е създаден успешно",
  "createError": "Грешка при създаване на проект",
  "statusPlanning": "Планиране",
  "statusInProgress": "В изпълнение",
  "statusCompleted": "Завършен",
  "statusPaused": "Паузиран",
  "statusArchived": "Архивиран",
  "backToProjects": "Обратно към проекти",
  "projectInfo": "Информация за проекта",
  "createdAt": "Създаден",
  "editProject": "Редактирай проект",
  "save": "Запази",
  "cancel": "Отказ",
  "addMember": "Добави член",
  "removeMember": "Премахни член",
  "removeMemberConfirm": "Сигурни ли сте, че искате да премахнете този член от проекта?",
  "selectUser": "Изберете потребител...",
  "searchUsers": "Търсене на потребители...",
  "noUsersFound": "Не са намерени потребители.",
  "roleManager": "Мениджър",
  "roleSpecialist": "Специалист",
  "roleObserver": "Наблюдател",
  "assignSuccess": "Членът е назначен успешно",
  "removeSuccess": "Членът е премахнат успешно",
  "actions": "Действия",
  "editSuccess": "Проектът е актуализиран успешно"
}
```

When updating JSON files, read the existing content first and merge the new `projects` key into the existing object. Do NOT overwrite the whole file.
  </action>
  <verify>
`cd /home/rosen/fiberq/web && node -e "require('maplibre-gl'); console.log('maplibre-gl OK')"` -- dependency installed.
`ls web/src/components/ui/command.tsx web/src/components/ui/popover.tsx web/src/components/ui/scroll-area.tsx` -- shadcn components added.
`cd /home/rosen/fiberq/web && npx tsc --noEmit --pretty 2>&1 | head -20` -- no type errors in new files.
`node -e "const en = require('./web/src/messages/en.json'); console.log(!!en.projects.title ? 'EN OK' : 'MISSING')"` -- translations present.
  </verify>
  <done>
maplibre-gl installed, shadcn command/popover/scroll-area added, project types defined, server actions created, and both EN/BG translations include all project-related keys.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build project list page with card grid, mini-map component, filters, create dialog, and empty states</name>
  <files>
    web/src/app/[locale]/projects/page.tsx
    web/src/app/[locale]/projects/_components/projects-client.tsx
    web/src/app/[locale]/projects/_components/project-card.tsx
    web/src/app/[locale]/projects/_components/project-mini-map.tsx
    web/src/app/[locale]/projects/_components/create-project-dialog.tsx
  </files>
  <action>
1. **Replace web/src/app/[locale]/projects/page.tsx** -- Server Component following Phase 2 users page pattern:
   - Import `auth`, `apiFetch`, `setRequestLocale`, `getTranslations`, `redirect`
   - Define `ApiProject` type matching backend response (id, name, description, status, member_count, extent, created_at)
   - Define `mapProject()` function converting snake_case to camelCase (member_count -> memberCount, created_at -> createdAt)
   - Fetch projects via `apiFetch<ApiProject[]>("/projects")` with try/catch (empty array on failure)
   - Get user session for role check (pass `isAdmin` boolean to client)
   - Render `<ProjectsClient projects={projects} locale={locale} isAdmin={isAdmin} />`
   - Also extract unique member names from projects for filter (not needed here -- filter by status is sufficient for list)

2. **Create web/src/app/[locale]/projects/_components/projects-client.tsx** -- "use client" wrapper:
   - Props: `{ projects: ProjectCard[], locale: string, isAdmin: boolean }`
   - State: `searchQuery` (string), `statusFilter` (string | "all"), `showCreateDialog` (boolean)
   - Use `useTranslations("projects")` for i18n
   - **Header row:** Title on left, "Create Project" button on right (visible only to admin/PM -- pass `isAdmin` or check `canCreate` prop)
   - **Filter bar:**
     - Text input for name search (controlled, filters cards client-side)
     - Select dropdown for status filter with options: All, Planning, In Progress, Completed, Paused, Archived
   - **Card grid:** `grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4`
     - Filter projects by searchQuery (case-insensitive name match) and statusFilter
     - Map filtered projects to `<ProjectCard />` components
   - **Empty state:** When no projects after filtering:
     - If `isAdmin` and no projects at all: "No projects yet. Create your first project."
     - If not admin and no projects: "You have no assigned projects. Contact an administrator." (per user decision)
   - **CreateProjectDialog:** Rendered at bottom, controlled by `showCreateDialog` state
   - Clicking a card navigates to `/${locale}/projects/${project.id}` -- use Next.js `useRouter` or make the card an `<Link>` wrapper

3. **Create web/src/app/[locale]/projects/_components/project-card.tsx** -- Individual card:
   - Props: `{ project: ProjectCard, locale: string }`
   - Use shadcn `Card` component
   - Layout (per user decision -- map on top, info below):
     ```
     +---------------------------+
     | [ProjectMiniMap: 100%w,   |
     |  ~120px height]           |
     +---------------------------+
     | Project Name (font-medium)|
     | StatusBadge   N members   |
     | Description (truncated)   |
     +---------------------------+
     ```
   - Mini-map at top: `<ProjectMiniMap extent={project.extent} className="h-[120px] w-full rounded-t-lg" />`
   - Below map in CardContent: project name (bold/medium), status badge (color-coded), member count, truncated description (line-clamp-2)
   - Wrap entire card in `<Link href={/${locale}/projects/${project.id}}>` for navigation
   - **Status badge colors:** Use a utility function mapping status to Badge variant + className:
     - planning: variant="secondary"
     - in_progress: variant="default" (primary teal)
     - completed: className with green-600 override
     - paused: variant="outline"
     - archived: variant="secondary" + opacity-60
   - Status label: use translations (t(`status${capitalize(status)}`)) -- map "planning" -> "statusPlanning", etc.

4. **Create web/src/app/[locale]/projects/_components/project-mini-map.tsx** -- "use client" MapLibre component:
   - Props: `{ extent: GeoJSON.Geometry | null, className?: string }`
   - Use `useRef` for container div and map instance
   - Use `useEffect` to create MapLibre map on mount:
     - `interactive: false` (non-interactive per user decision)
     - `attributionControl: false`
     - Style: inline OSM raster tiles (no external style.json)
     - On "load" event: add GeoJSON source from extent, add fill layer (primary teal, 0.15 opacity), add line layer (primary teal, 2px width)
     - Fit bounds using `map.fitBounds()` computed from polygon coordinates with padding: 20
   - Cleanup: `map.remove()` in useEffect return
   - **Null extent handling:** Show a placeholder div with "No geographic data" text, same dimensions, bg-muted background
   - **Lazy loading for WebGL context limits:** Use Intersection Observer to only instantiate the map when the card is in viewport. When out of viewport, show a static placeholder. This prevents hitting the browser's WebGL context limit (~16) with many cards.
     - Create a state `isVisible` (default false)
     - Use `useEffect` with `IntersectionObserver` on containerRef
     - Only create MapLibre map when `isVisible && extent`
     - On disconnect (card leaves viewport for long time), optionally destroy map to free context
   - Import CSS: `import "maplibre-gl/dist/maplibre-gl.css"` at the top of the file
   - Use `dynamic import` with `ssr: false` is NOT needed here since the component is already "use client" and we use useEffect -- MapLibre only runs client-side in the effect

5. **Create web/src/app/[locale]/projects/_components/create-project-dialog.tsx** -- Modal dialog following Phase 2 create-user-dialog pattern:
   - Props: `{ open: boolean, onOpenChange: (open: boolean) => void }`
   - Use shadcn Dialog, react-hook-form + zod for validation
   - Schema: name (string, min 1, max 100), description (string, optional)
   - Fields: Name (Input, required), Description (Textarea or Input multiline)
   - On submit: call `createProject` server action from _actions.ts
   - On success: show toast via sonner, close dialog, router.refresh() to update list
   - On error: show toast with error message
   - Use `useTranslations("projects")` for all labels
  </action>
  <verify>
`cd /home/rosen/fiberq/web && npx tsc --noEmit --pretty 2>&1 | head -30` -- no type errors.
`ls web/src/app/[locale]/projects/_components/` -- all 4 component files exist.
`grep 'maplibregl' web/src/app/[locale]/projects/_components/project-mini-map.tsx` -- MapLibre imported.
`grep 'createProject' web/src/app/[locale]/projects/_components/create-project-dialog.tsx` -- Server action connected.
`grep 'ProjectsClient' web/src/app/[locale]/projects/page.tsx` -- client wrapper used.
  </verify>
  <done>
Project list page renders a responsive card grid (1/2/3 columns) with PostGIS mini-maps, status badges, member counts, and truncated descriptions. Filters by name and status work client-side. Create dialog submits via server action. Empty states differ for admin vs non-admin. Cards link to detail page. Mini-maps use Intersection Observer for lazy loading to handle WebGL limits.
  </done>
</task>

</tasks>

<verification>
1. `cd /home/rosen/fiberq/web && npx tsc --noEmit` -- zero TypeScript errors
2. `cd /home/rosen/fiberq/web && npm run build 2>&1 | tail -5` -- build succeeds
3. Projects page replaces the old placeholder content (no Skeleton imports from old page remain)
4. All translation keys used in components exist in both en.json and bg.json
5. MapLibre CSS imported in mini-map component
</verification>

<success_criteria>
Project list page shows a card grid with mini-maps, status badges, member counts, and filtering. Admin/PM can create projects via modal. Non-admin users without projects see the correct empty state. Cards navigate to detail page on click.
</success_criteria>

<output>
After completion, create `.planning/phases/03-project-management-assignment/03-02-SUMMARY.md`
</output>
