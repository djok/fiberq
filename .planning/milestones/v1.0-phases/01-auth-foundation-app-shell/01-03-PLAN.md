---
phase: 01-auth-foundation-app-shell
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - web/src/app/[locale]/profile/page.tsx
  - web/src/app/[locale]/dashboard/page.tsx
  - web/src/app/[locale]/projects/page.tsx
  - web/src/app/[locale]/users/page.tsx
  - web/src/components/profile-card.tsx
  - web/src/components/user-nav.tsx
  - web/src/components/app-sidebar.tsx
  - web/src/auth.ts
  - web/src/types/next-auth.d.ts
  - web/src/lib/api.ts
  - web/src/messages/en.json
  - web/src/messages/bg.json
autonomous: false

must_haves:
  truths:
    - "User can view their profile page showing name, email, role, and last login timestamp"
    - "Profile page shows Zitadel avatar if available, otherwise initials"
    - "Profile page has an 'Edit profile' link that opens Zitadel account page in a new tab"
    - "Assigned projects list shows a placeholder message (data not available until Phase 3)"
    - "User can log out from any page and is redirected to login with Zitadel session ended"
    - "Placeholder pages exist for Dashboard, Projects, and Users"
    - "The application layout renders correctly at 768px viewport width"
  artifacts:
    - path: "web/src/app/[locale]/profile/page.tsx"
      provides: "Profile page with user data from session and Zitadel userinfo"
      contains: "session.user"
    - path: "web/src/components/profile-card.tsx"
      provides: "Profile data display card with avatar, name, email, role, projects placeholder"
      contains: "Avatar"
    - path: "web/src/app/[locale]/dashboard/page.tsx"
      provides: "Dashboard placeholder page"
      contains: "placeholder"
    - path: "web/src/app/[locale]/projects/page.tsx"
      provides: "Projects placeholder page"
      contains: "placeholder"
    - path: "web/src/app/[locale]/users/page.tsx"
      provides: "Users placeholder page (admin only)"
      contains: "placeholder"
  key_links:
    - from: "web/src/app/[locale]/profile/page.tsx"
      to: "web/src/auth.ts"
      via: "auth() to get session with user data"
      pattern: "auth\\(\\)"
    - from: "web/src/components/user-nav.tsx"
      to: "Zitadel end_session_endpoint"
      via: "Federated logout redirect after local signOut"
      pattern: "end_session"
    - from: "web/src/app/[locale]/profile/page.tsx"
      to: "Zitadel account page"
      via: "Edit profile link opens external URL"
      pattern: "target.*_blank"
---

<objective>
Build the profile page, implement federated logout (clearing both local and Zitadel sessions), create placeholder pages for Dashboard/Projects/Users, and verify the complete auth flow end-to-end.

Purpose: This completes all 6 Phase 1 requirements. The profile page satisfies AUTH-04, federated logout satisfies AUTH-03, placeholder pages provide navigation targets, and the final checkpoint verifies all requirements including responsive layout (UIUX-02).

Output: Fully functional authenticated app shell with profile page, working login/logout, role-based navigation, responsive layout, and bilingual support.
</objective>

<execution_context>
@/home/rosen/.claude/get-shit-done/workflows/execute-plan.md
@/home/rosen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-auth-foundation-app-shell/01-RESEARCH.md
@.planning/phases/01-auth-foundation-app-shell/01-CONTEXT.md
@.planning/phases/01-auth-foundation-app-shell/01-01-SUMMARY.md
@.planning/phases/01-auth-foundation-app-shell/01-02-SUMMARY.md
@web/src/auth.ts
@web/src/lib/roles.ts
@web/src/lib/api.ts
@web/src/components/user-nav.tsx
@web/src/messages/en.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build profile page and placeholder pages</name>
  <files>
    web/src/app/[locale]/profile/page.tsx
    web/src/components/profile-card.tsx
    web/src/app/[locale]/dashboard/page.tsx
    web/src/app/[locale]/projects/page.tsx
    web/src/app/[locale]/users/page.tsx
    web/src/messages/en.json
    web/src/messages/bg.json
  </files>
  <action>
    **Step 1: Create `src/components/profile-card.tsx`.**
    Server Component (no "use client").
    Props: `user: { name?: string | null; email?: string | null; image?: string | null; roles: string[] }`, `locale: string`.

    Layout: A card-based layout using shadcn/ui components. Data-dense, compact (per user decision).

    Structure:
    - Top section: Large avatar (80px) with `<Avatar>` + `<AvatarImage src={user.image}>` + `<AvatarFallback>` (initials from name). Next to avatar: user name (heading), email (muted text), role badge(s).
    - Role badge: Display the user's primary role using a colored badge. Use the i18n key `roles.{role}` for display. If multiple roles, show all as badges.
    - Info grid (2 columns on desktop, 1 on mobile):
      - **Email**: user.email
      - **Role**: user.roles joined
      - **Last Login**: Display the current timestamp as a placeholder. In production, this would come from Zitadel userinfo `auth_time` claim or session data. For now, use `new Date().toLocaleString(locale)` -- the actual last login timestamp comes from the JWT `auth_time` claim which Auth.js exposes. If available from session, use it; otherwise show "N/A".
      - **Assigned Projects**: Placeholder text -- "No projects assigned yet. Projects will appear here after assignment in Phase 3." Use i18n key `profile.noProjects`.
    - Bottom: "Edit Profile" button/link that opens `${process.env.ZITADEL_ISSUER || process.env.NEXT_PUBLIC_ZITADEL_ISSUER}/ui/console/users/me` in a new tab (`target="_blank"`, `rel="noopener noreferrer"`). Use an ExternalLink icon from Lucide. The Zitadel account page URL pattern is `https://{zitadel_domain}/ui/console/users/me`. Since this is a server component, read `process.env.ZITADEL_ISSUER` directly. Label with i18n key `profile.editProfile`.

    Use `useTranslations("profile")` if client component, or `getTranslations("profile")` if server component. Since we read env vars server-side, keep as Server Component and use `getTranslations`.

    **Step 2: Create `src/app/[locale]/profile/page.tsx`.**
    Server Component.
    - Call `auth()` to get session.
    - If no session, redirect to login.
    - Call `setRequestLocale(locale)` for static rendering.
    - Get `locale` from params (await params).
    - Get translations via `getTranslations("profile")`.
    - Render page title (`<h1>` with `profile.title` translation) and `<ProfileCard user={session.user} locale={locale} />`.
    - Wrap in a container with max width and padding.

    **Step 3: Create placeholder pages.**

    `src/app/[locale]/dashboard/page.tsx`:
    - Server Component. Page title "Dashboard" (i18n: `nav.dashboard`).
    - Body: A centered card with muted text: "Dashboard coming in Phase 4" (i18n: `placeholder.dashboard`).
    - Use `<Skeleton>` components to hint at future content layout (2-3 stat cards, an activity feed area).

    `src/app/[locale]/projects/page.tsx`:
    - Server Component. Page title "Projects" (i18n: `nav.projects`).
    - Body: "Project management coming in Phase 3" (i18n: `placeholder.projects`).
    - Use `<Skeleton>` for a table-like layout hint.

    `src/app/[locale]/users/page.tsx`:
    - Server Component. Page title "User Management" (i18n: `nav.users`).
    - Body: "User management coming in Phase 2" (i18n: `placeholder.users`).
    - Use `<Skeleton>` for a table-like layout hint.
    - NOTE: This page should also enforce admin-only access server-side. Check `session.user.roles.includes("admin")` -- if not admin, redirect to `/projects` or return `notFound()`.

    **Step 4: Update translation files.**
    Add to `src/messages/en.json`:
    ```json
    "placeholder": {
      "dashboard": "Dashboard analytics coming in a future update.",
      "projects": "Project management coming in a future update.",
      "users": "User management coming in a future update.",
      "comingSoon": "Coming Soon"
    },
    "roles": {
      "admin": "Administrator",
      "project_manager": "Project Manager",
      "engineer": "Engineer",
      "field_worker": "Field Worker"
    }
    ```

    Add equivalent Bulgarian translations to `src/messages/bg.json`:
    ```json
    "placeholder": {
      "dashboard": "Анализи и статистики ще бъдат добавени в бъдеща актуализация.",
      "projects": "Управление на проекти ще бъде добавено в бъдеща актуализация.",
      "users": "Управление на потребители ще бъде добавено в бъдеща актуализация.",
      "comingSoon": "Очаквайте скоро"
    },
    "roles": {
      "admin": "Администратор",
      "project_manager": "Проект мениджър",
      "engineer": "Инженер",
      "field_worker": "Полеви работник"
    }
    ```

    Ensure ALL i18n keys used across all components are present in both language files.
  </action>
  <verify>
    Run `cd /home/rosen/fiberq/web && npx tsc --noEmit` -- no type errors.
    Run `npm run build` -- should complete without errors.
    Verify `src/app/[locale]/profile/page.tsx` calls `auth()` and renders `ProfileCard`.
    Verify `src/components/profile-card.tsx` contains `target="_blank"` for edit profile link.
    Verify `src/app/[locale]/users/page.tsx` checks for admin role.
    Verify `src/messages/en.json` has `placeholder`, `roles` keys.
    Verify `src/messages/bg.json` has matching keys with Bulgarian text.
  </verify>
  <done>
    Profile page shows user data (name, email, role, avatar, last login, projects placeholder) with "Edit Profile" link to Zitadel. Placeholder pages exist for Dashboard, Projects, Users with skeleton layouts and coming-soon messages. Users page enforces admin-only access. All text available in both EN and BG.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement federated logout (local + Zitadel session end)</name>
  <files>
    web/src/components/user-nav.tsx
    web/src/components/app-sidebar.tsx
    web/src/auth.ts
    web/src/types/next-auth.d.ts
    web/src/lib/api.ts
  </files>
  <action>
    **Step 1: Implement federated logout in `user-nav.tsx`.**

    The current `signOut()` from `next-auth/react` only clears the local NextAuth session cookie. For full logout per AUTH-03, we must also end the Zitadel server session.

    Zitadel federated logout flow:
    1. Clear the local NextAuth session.
    2. Redirect to Zitadel's `end_session_endpoint`: `https://{ZITADEL_DOMAIN}/oidc/v1/end_session?id_token_hint={id_token}&post_logout_redirect_uri={app_url}`.

    Implementation approach:
    - Create a server action or API route for logout that:
      a. Gets the current session (including `idToken` from the JWT).
      b. Clears the local session.
      c. Returns the Zitadel end_session URL with `id_token_hint` parameter.
    - The client-side sign out button triggers this flow.

    Simplest approach: Use Auth.js `signOut` with a custom redirect.

    Since Auth.js v5 does not natively support federated logout with Zitadel, implement it as follows:

    Option A (recommended -- server action):
    Create a `logoutAction` in a separate file or inline:
    ```typescript
    // In user-nav.tsx or a separate actions file
    "use server";
    import { auth, signOut } from "@/auth";

    export async function federatedLogout() {
      const session = await auth();
      // Get id_token from JWT for the end_session hint
      // We need to access the JWT directly since session doesn't expose idToken
      // Auth.js signOut clears the local session
      await signOut({ redirect: false });

      // Build Zitadel end_session URL
      const issuer = process.env.ZITADEL_ISSUER;
      const postLogoutUri = encodeURIComponent(process.env.NEXTAUTH_URL || "http://localhost:3000");
      // id_token_hint needs to come from the JWT -- we stored it in the jwt callback
      // Since we can't easily access the raw JWT from a server action after signOut,
      // we need to get it BEFORE signing out
      const endSessionUrl = `${issuer}/oidc/v1/end_session?post_logout_redirect_uri=${postLogoutUri}`;
      return endSessionUrl;
    }
    ```

    Actually, the cleaner approach:

    1. Add `idToken` to the session in `auth.ts` session callback: `session.idToken = token.idToken as string;`. Update the `next-auth.d.ts` type augmentation to include `idToken?: string` on Session.
    2. In `user-nav.tsx`, read `session.idToken` (already available via props).
    3. On sign out click: First, build the Zitadel end_session URL with `id_token_hint=${session.idToken}`. Then call `signOut({ redirect: false })` to clear local session. Then `window.location.href = endSessionUrl` to redirect to Zitadel for server session cleanup.

    Update `src/auth.ts` session callback to include:
    ```typescript
    session.idToken = token.idToken as string;
    ```

    Update `src/types/next-auth.d.ts`:
    ```typescript
    interface Session extends DefaultSession {
      accessToken?: string;
      idToken?: string;  // Add this
      error?: string;
      user: {
        roles: string[];
      } & DefaultSession["user"];
    }
    ```

    In `user-nav.tsx` sign out handler:
    ```typescript
    const handleSignOut = async () => {
      const issuer = process.env.NEXT_PUBLIC_ZITADEL_ISSUER; // Need this client-side
      // OR pass it as a prop from the server component
      const idToken = session.idToken;
      const postLogoutUri = encodeURIComponent(window.location.origin);
      const endSessionUrl = `${issuer}/oidc/v1/end_session?id_token_hint=${idToken}&post_logout_redirect_uri=${postLogoutUri}`;

      // Clear local session first
      await signOut({ redirect: false });
      // Then redirect to Zitadel to clear server session
      window.location.href = endSessionUrl;
    };
    ```

    Since `process.env.NEXT_PUBLIC_*` is needed client-side, add `NEXT_PUBLIC_ZITADEL_ISSUER` to `.env.local` (same value as `ZITADEL_ISSUER`). OR, better: pass the `zitadelIssuer` as a prop from the server component (`app-sidebar.tsx` or `[locale]/layout.tsx`) to avoid exposing env vars client-side. The server reads `process.env.ZITADEL_ISSUER` and passes it down.

    Recommended: In `app-sidebar.tsx` (server component), pass `zitadelIssuer={process.env.ZITADEL_ISSUER}` to `<UserNav>`. In `user-nav.tsx`, accept `zitadelIssuer: string` prop.

    **Step 2: Update `src/lib/api.ts` -- add userinfo fetch helper.**
    Add a `fetchUserInfo()` function that calls the Zitadel userinfo endpoint to get additional profile data (avatar, auth_time) that may not be in the standard OIDC claims:
    ```typescript
    export async function fetchUserInfo() {
      const session = await auth();
      if (!session?.accessToken) return null;

      const issuer = process.env.ZITADEL_ISSUER;
      try {
        const res = await fetch(`${issuer}/oidc/v1/userinfo`, {
          headers: { Authorization: `Bearer ${session.accessToken}` },
        });
        if (!res.ok) return null;
        return res.json();
      } catch {
        return null;
      }
    }
    ```
    This can be used by the profile page to get `auth_time` (last login) and `picture` (avatar URL) if they're not already in the session.

    Also add `ZITADEL_ISSUER` and `NEXT_PUBLIC_ZITADEL_ISSUER` to the Docker Compose web service environment (update `server/docker-compose.yml`). Actually, `ZITADEL_ISSUER` is already there. For client-side, we pass it as a prop from server components, so no `NEXT_PUBLIC_*` env var needed.
  </action>
  <verify>
    Run `cd /home/rosen/fiberq/web && npx tsc --noEmit` -- no type errors.
    Run `npm run build` -- should complete without errors.
    Verify `src/components/user-nav.tsx` contains `end_session` URL construction.
    Verify `src/components/user-nav.tsx` calls `signOut({ redirect: false })` before Zitadel redirect.
    Verify `src/types/next-auth.d.ts` includes `idToken` on Session interface.
    Verify `src/auth.ts` session callback sets `session.idToken`.
    Verify `src/lib/api.ts` contains `fetchUserInfo` function.
  </verify>
  <done>
    Federated logout clears both local NextAuth session and Zitadel server session. Sign out from any page redirects through Zitadel end_session endpoint with id_token_hint, then back to the app (which redirects to Zitadel login since unauthenticated). Userinfo fetch helper available for profile enrichment.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete Phase 1 auth flow and responsive layout</name>
  <what-built>
    Complete Phase 1 implementation: Zitadel OIDC login, session persistence, federated logout, profile page, role-based navigation, collapsible sidebar, responsive layout, dark/light theme, BG/EN bilingual support.
  </what-built>
  <how-to-verify>
    Prerequisites: Ensure Zitadel application is configured (see user_setup in Plan 01) and `.env.local` has valid credentials.

    **AUTH-01: Login via Zitadel OIDC**
    1. Start the dev server: `cd /home/rosen/fiberq/web && npm run dev`
    2. Open http://localhost:3000 in a browser
    3. Expected: Immediate redirect to Zitadel login page (no FiberQ landing page)
    4. Log in with valid credentials
    5. Expected: Redirect to role-appropriate page (admin -> /users, others -> /projects)

    **AUTH-02: Session persistence**
    6. After login, hard-refresh the page (Ctrl+F5)
    7. Expected: Page renders with data, no redirect to login
    8. Open a new tab, navigate to http://localhost:3000/en/profile
    9. Expected: Profile page loads without re-login

    **AUTH-03: Logout**
    10. Click user avatar in sidebar footer, then "Sign Out"
    11. Expected: Redirected to Zitadel, then back to app login page
    12. Try navigating to http://localhost:3000/en/profile
    13. Expected: Redirected to Zitadel login (session fully cleared)

    **AUTH-04: Profile page**
    14. After re-login, navigate to Profile page
    15. Expected: See name, email, role badge, avatar (or initials), last login time
    16. Expected: "Assigned Projects" section shows placeholder message
    17. Expected: "Edit Profile" link opens Zitadel account page in new tab

    **UIUX-01: Role-based navigation**
    18. If logged in as admin: sidebar shows Dashboard, Projects, Users, Profile
    19. If logged in as non-admin: sidebar does NOT show Users link
    20. Navigate to /users directly as non-admin: expected 404 or redirect

    **UIUX-02: Responsive layout**
    21. Resize browser to 768px width (or use DevTools responsive mode)
    22. Expected: Sidebar collapses to icons only
    23. Resize to 600px width
    24. Expected: Sidebar hidden, hamburger menu button visible; clicking opens sidebar as overlay

    **Theme and Language**
    25. Click theme toggle: switch to dark mode
    26. Expected: Background, sidebar, cards switch to dark colors (teal-accented dark theme)
    27. Click language switcher to BG
    28. Expected: Navigation labels, profile labels, placeholders switch to Bulgarian
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe which checks failed and what you observed.</resume-signal>
</task>

</tasks>

<verification>
1. `cd /home/rosen/fiberq/web && npm run build` succeeds
2. All 6 requirements verified via manual testing (AUTH-01 through AUTH-04, UIUX-01, UIUX-02)
3. Federated logout clears both local and Zitadel sessions
4. Profile page shows all required fields
5. Responsive layout works at 768px viewport
6. Theme and language switching functional
</verification>

<success_criteria>
- User can log in via Zitadel OIDC and session persists across refresh (AUTH-01, AUTH-02)
- User can log out from any page with full session cleanup (AUTH-03)
- Profile page shows name, email, role, avatar, last login, projects placeholder, edit link (AUTH-04)
- Admin sees Users nav item, non-admin does not (UIUX-01)
- Layout renders correctly at 768px viewport (UIUX-02)
- Placeholder pages exist for Dashboard, Projects, Users
- Federated logout ends both local and Zitadel sessions
- All text available in both Bulgarian and English
</success_criteria>

<output>
After completion, create `.planning/phases/01-auth-foundation-app-shell/01-03-SUMMARY.md`
</output>
