---
phase: 01-auth-foundation-app-shell
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - web/src/app/globals.css
  - web/src/app/[locale]/layout.tsx
  - web/src/app/[locale]/page.tsx
  - web/src/components/providers.tsx
  - web/src/components/app-sidebar.tsx
  - web/src/components/sidebar-nav.tsx
  - web/src/components/user-nav.tsx
  - web/src/components/theme-toggle.tsx
  - web/src/components/language-switcher.tsx
  - web/public/logo.svg
autonomous: true

must_haves:
  truths:
    - "Authenticated user sees a sidebar with navigation items appropriate to their role"
    - "Admin user sees Dashboard, Projects, Users, Profile in sidebar; Field Worker sees no Users link"
    - "Sidebar collapses to icons on tablet viewport (768-1023px) and expands on desktop"
    - "On mobile (<768px) sidebar renders as a slide-over Sheet triggered by hamburger button"
    - "User can toggle between Bulgarian and English, and all visible text updates"
    - "Theme follows system preference (dark mode when OS is dark)"
    - "FiberQ logo and name are visible in the sidebar header"
    - "Color palette is green/teal (not default shadcn blue/zinc)"
  artifacts:
    - path: "web/src/app/[locale]/layout.tsx"
      provides: "Authenticated shell layout wrapping all pages with sidebar + SidebarProvider"
      contains: "SidebarProvider"
    - path: "web/src/components/providers.tsx"
      provides: "Combined SessionProvider + ThemeProvider + NextIntlClientProvider"
      exports: ["Providers"]
    - path: "web/src/components/app-sidebar.tsx"
      provides: "Main sidebar with collapsible=icon, header, nav, footer"
      contains: "collapsible"
    - path: "web/src/components/sidebar-nav.tsx"
      provides: "Role-filtered navigation items using filterNavByRole"
      contains: "filterNavByRole"
    - path: "web/src/components/user-nav.tsx"
      provides: "User avatar dropdown with profile link and sign out"
      contains: "signOut"
    - path: "web/src/components/theme-toggle.tsx"
      provides: "Theme toggle (light/dark/system)"
      contains: "useTheme"
    - path: "web/src/components/language-switcher.tsx"
      provides: "BG/EN language toggle using next-intl routing"
      contains: "useRouter"
    - path: "web/src/app/globals.css"
      provides: "Green/teal oklch color palette for light and dark themes"
      contains: "oklch"
  key_links:
    - from: "web/src/app/[locale]/layout.tsx"
      to: "web/src/components/providers.tsx"
      via: "Providers wrapper with session, theme, intl"
      pattern: "<Providers"
    - from: "web/src/app/[locale]/layout.tsx"
      to: "web/src/components/app-sidebar.tsx"
      via: "SidebarProvider + AppSidebar rendering"
      pattern: "<AppSidebar"
    - from: "web/src/components/sidebar-nav.tsx"
      to: "web/src/lib/roles.ts"
      via: "filterNavByRole with session.user.roles"
      pattern: "filterNavByRole"
    - from: "web/src/components/user-nav.tsx"
      to: "web/src/auth.ts"
      via: "signOut for logout action"
      pattern: "signOut"
---

<objective>
Build the authenticated application shell with collapsible sidebar navigation, role-based menu filtering, green/teal theming, dark mode, and bilingual (BG/EN) support.

Purpose: This is the layout every page renders within. The sidebar, theme, and language infrastructure must work before any page content (profile, placeholders) can be built. Role-based navigation filtering enforces access control at the UI level.

Output: A complete responsive shell that adapts to roles, viewport size, language, and theme -- ready to host page content.
</objective>

<execution_context>
@/home/rosen/.claude/get-shit-done/workflows/execute-plan.md
@/home/rosen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-auth-foundation-app-shell/01-RESEARCH.md
@.planning/phases/01-auth-foundation-app-shell/01-CONTEXT.md
@.planning/phases/01-auth-foundation-app-shell/01-01-SUMMARY.md
@web/src/lib/roles.ts
@web/src/auth.ts
@web/src/i18n/routing.ts
@web/src/messages/en.json
@web/src/messages/bg.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create green/teal color palette, data-dense typography, and providers</name>
  <files>
    web/src/app/globals.css
    web/src/components/providers.tsx
    web/public/logo.svg
  </files>
  <action>
    **Step 1: Update `src/app/globals.css` with green/teal oklch color palette.**

    Replace the default shadcn/ui color variables with a green/teal palette. Use the oklch color space per research recommendations.

    Light mode CSS variables (inside `@layer base { :root { ... } }`):
    ```
    --background: oklch(0.98 0.005 165);
    --foreground: oklch(0.15 0.02 250);
    --card: oklch(1 0 0);
    --card-foreground: oklch(0.15 0.02 250);
    --popover: oklch(1 0 0);
    --popover-foreground: oklch(0.15 0.02 250);
    --primary: oklch(0.55 0.15 165);
    --primary-foreground: oklch(0.98 0.01 165);
    --secondary: oklch(0.92 0.04 165);
    --secondary-foreground: oklch(0.25 0.06 165);
    --muted: oklch(0.95 0.02 250);
    --muted-foreground: oklch(0.45 0.02 250);
    --accent: oklch(0.92 0.04 165);
    --accent-foreground: oklch(0.25 0.06 165);
    --destructive: oklch(0.55 0.2 25);
    --destructive-foreground: oklch(0.98 0 0);
    --border: oklch(0.88 0.02 165);
    --input: oklch(0.88 0.02 165);
    --ring: oklch(0.55 0.15 165);
    --radius: 0.375rem;
    --sidebar-background: oklch(0.97 0.01 165);
    --sidebar-foreground: oklch(0.25 0.06 165);
    --sidebar-primary: oklch(0.55 0.15 165);
    --sidebar-primary-foreground: oklch(0.98 0.01 165);
    --sidebar-accent: oklch(0.92 0.04 165);
    --sidebar-accent-foreground: oklch(0.25 0.06 165);
    --sidebar-border: oklch(0.88 0.02 165);
    --sidebar-ring: oklch(0.55 0.15 165);
    ```

    Dark mode (inside `.dark { ... }`):
    ```
    --background: oklch(0.13 0.02 250);
    --foreground: oklch(0.93 0.01 165);
    --card: oklch(0.17 0.02 250);
    --card-foreground: oklch(0.93 0.01 165);
    --popover: oklch(0.17 0.02 250);
    --popover-foreground: oklch(0.93 0.01 165);
    --primary: oklch(0.65 0.15 165);
    --primary-foreground: oklch(0.13 0.02 250);
    --secondary: oklch(0.22 0.04 165);
    --secondary-foreground: oklch(0.93 0.01 165);
    --muted: oklch(0.22 0.02 250);
    --muted-foreground: oklch(0.63 0.02 250);
    --accent: oklch(0.22 0.04 165);
    --accent-foreground: oklch(0.93 0.01 165);
    --destructive: oklch(0.55 0.2 25);
    --destructive-foreground: oklch(0.98 0 0);
    --border: oklch(0.27 0.02 250);
    --input: oklch(0.27 0.02 250);
    --ring: oklch(0.65 0.15 165);
    --sidebar-background: oklch(0.15 0.02 250);
    --sidebar-foreground: oklch(0.93 0.01 165);
    --sidebar-primary: oklch(0.65 0.15 165);
    --sidebar-primary-foreground: oklch(0.13 0.02 250);
    --sidebar-accent: oklch(0.22 0.04 165);
    --sidebar-accent-foreground: oklch(0.93 0.01 165);
    --sidebar-border: oklch(0.27 0.02 250);
    --sidebar-ring: oklch(0.65 0.15 165);
    ```

    Data-dense typography overrides (in base layer):
    ```css
    body {
      font-size: 0.875rem; /* 14px base instead of 16px */
      line-height: 1.4;
      font-variant-numeric: tabular-nums;
    }
    ```

    The radius should be `0.375rem` (6px) for compact feel per user decision "data-dense, compact".

    **Step 2: Create `src/components/providers.tsx`.**
    Client component (`"use client"`). Wraps children in:
    1. `SessionProvider` from `next-auth/react` (no props needed, uses default session fetching).
    2. `NextIntlClientProvider` with `locale` and `messages` props.
    3. `ThemeProvider` from `next-themes` with `attribute="class"`, `defaultTheme="system"`, `enableSystem`, `disableTransitionOnChange`.

    Props: `children`, `locale: string`, `messages: Record<string, unknown>`.

    **Step 3: Create `public/logo.svg`.**
    Create a simple FiberQ logo SVG -- a stylized "F" or fiber optic cable icon in teal color. Keep it minimal: a geometric fiber/network icon that works at small sizes (sidebar header). Use the primary teal color `oklch(0.55 0.15 165)` or a close hex equivalent (`#0d9488` / teal-600). The SVG should work at both 32x32 and 24x24 sizes. If creating a detailed logo is complex, a simple geometric mark (interconnected nodes or a fiber strand) is sufficient.
  </action>
  <verify>
    Run `cd /home/rosen/fiberq/web && npx tsc --noEmit` -- no type errors.
    Verify `src/app/globals.css` contains `oklch(0.55 0.15 165)` for primary color.
    Verify `src/components/providers.tsx` imports SessionProvider, ThemeProvider, NextIntlClientProvider.
    Verify `public/logo.svg` exists and is valid SVG.
  </verify>
  <done>
    Green/teal color palette applied to both light and dark modes using oklch. Data-dense typography set (14px base, tight line-height, tabular-nums). Providers component combines auth session, i18n, and theme. Logo SVG ready.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build the collapsible sidebar shell with role-based navigation</name>
  <files>
    web/src/app/[locale]/layout.tsx
    web/src/app/[locale]/page.tsx
    web/src/components/app-sidebar.tsx
    web/src/components/sidebar-nav.tsx
    web/src/components/user-nav.tsx
    web/src/components/theme-toggle.tsx
    web/src/components/language-switcher.tsx
  </files>
  <action>
    **Step 1: Create `src/app/[locale]/layout.tsx`.**
    This is the authenticated layout for all locale-prefixed pages. It is a Server Component.

    Logic:
    1. Get `locale` from params (use `await params` -- Next.js 16 requirement).
    2. Validate locale using `hasLocale` from next-intl -- if invalid, call `notFound()`.
    3. Call `auth()` to get the session. If no session, redirect to `/api/auth/signin/zitadel` (this is a backup -- proxy.ts should catch this first, but defense-in-depth).
    4. Load messages via `getMessages()` from `next-intl/server`.
    5. Render: `<Providers locale={locale} messages={messages}>` wrapping `<SidebarProvider>` wrapping `<AppSidebar session={session} />` + `<SidebarInset>` containing a header bar (with `<SidebarTrigger />` for mobile toggle) and `<main>{children}</main>`.

    The header bar inside `<SidebarInset>` should include:
    - Left: `<SidebarTrigger />` (hamburger icon on mobile, collapse toggle on desktop)
    - Left: Breadcrumb or page title area (can be empty for now)
    - Right: `<LanguageSwitcher />`, `<ThemeToggle />`

    Use `setRequestLocale(locale)` from `next-intl/server` at the top of the component for static rendering support.

    Export `generateStaticParams` returning `routing.locales.map(locale => ({ locale }))`.

    **Step 2: Create `src/app/[locale]/page.tsx`.**
    Root page for authenticated users. Server Component.
    - Get session via `auth()`.
    - Import `getDefaultRedirect` from `@/lib/roles`.
    - Redirect to the role-based default page: `redirect(getDefaultRedirect(session.user.roles))`.
    - Use `redirect` from `next-intl/navigation` (locale-aware redirect, not next/navigation).

    **Step 3: Create `src/components/app-sidebar.tsx`.**
    Server Component that renders the shadcn/ui Sidebar structure.
    Props: `session` (the auth session object).

    Structure:
    ```
    <Sidebar collapsible="icon" variant="sidebar">
      <SidebarHeader>
        <SidebarMenu>
          <SidebarMenuItem>
            <SidebarMenuButton size="lg" asChild>
              <Link href="/">
                <Image src="/logo.svg" /> or inline SVG
                <div className="group-data-[collapsible=icon]:hidden">
                  <span className="font-semibold">FiberQ</span>
                  <span className="text-xs text-muted-foreground">Fiber Network Manager</span>
                </div>
              </Link>
            </SidebarMenuButton>
          </SidebarMenuItem>
        </SidebarMenu>
      </SidebarHeader>
      <SidebarContent>
        <SidebarNav roles={session.user.roles} />
      </SidebarContent>
      <SidebarFooter>
        <UserNav session={session} />
      </SidebarFooter>
      <SidebarRail />
    </Sidebar>
    ```

    The `group-data-[collapsible=icon]:hidden` class hides the text when sidebar is collapsed to icon mode. This is a built-in shadcn/ui sidebar pattern.

    **Step 4: Create `src/components/sidebar-nav.tsx`.**
    Client Component (`"use client"`).
    Props: `roles: string[]`.

    - Import `NAV_ITEMS` and `filterNavByRole` from `@/lib/roles`.
    - Import Lucide icons dynamically or use a map: `{ LayoutDashboard, FolderKanban, Users, UserCircle }` from `lucide-react`.
    - Call `filterNavByRole(NAV_ITEMS, roles)` to get the visible items.
    - Import `usePathname` from `@/i18n/navigation`.
    - Import `useTranslations` from `next-intl` with namespace `"nav"`.
    - Render as `<SidebarGroup>` > `<SidebarGroupLabel>Navigation</SidebarGroupLabel>` > `<SidebarMenu>` with `<SidebarMenuItem>` > `<SidebarMenuButton>` for each item.
    - Use `<Link href={item.href}>` from `@/i18n/navigation` (locale-aware).
    - Highlight active item using `isActive={pathname === item.href}` on `SidebarMenuButton`.
    - Use `<Tooltip>` wrapper for icon-only mode: the tooltip shows the nav item name when sidebar is collapsed.

    **Step 5: Create `src/components/user-nav.tsx`.**
    Client Component (`"use client"`).
    Props: `session` (auth session).

    Renders in `SidebarFooter`:
    - `<SidebarMenu>` > `<SidebarMenuItem>` > `<DropdownMenu>`.
    - Trigger: `<SidebarMenuButton size="lg">` showing avatar (user image from session or initials fallback) + user name + user email. Name/email hidden when collapsed via `group-data-[collapsible=icon]:hidden`.
    - Avatar: Use shadcn/ui `<Avatar>` with `<AvatarImage>` (from `session.user.image` -- Zitadel picture claim) and `<AvatarFallback>` (initials from `session.user.name`).
    - Dropdown content (aligned to side="top"):
      - User info section (name, email, role badge)
      - `<DropdownMenuItem>` for Profile link (`/profile`)
      - `<Separator />`
      - `<DropdownMenuItem>` for Sign Out -- calls logout action

    For Sign Out: Import `signOut` from `next-auth/react`. On click, call `signOut({ callbackUrl: "/" })`. NOTE: This only clears the local NextAuth session. Full federated logout (clearing Zitadel session) will be implemented in Plan 03 Task 2.

    **Step 6: Create `src/components/theme-toggle.tsx`.**
    Client Component (`"use client"`).
    - Import `useTheme` from `next-themes`.
    - Render a `<Button variant="ghost" size="icon">` that cycles through themes or shows a dropdown.
    - Use shadcn/ui `<DropdownMenu>` with three options: Light (Sun icon), Dark (Moon icon), System (Monitor icon).
    - Use Lucide icons: `Sun`, `Moon`, `Monitor` (or `SunMoon`).
    - Current theme indicated with a check mark or different styling.

    **Step 7: Create `src/components/language-switcher.tsx`.**
    Client Component (`"use client"`).
    - Import `useRouter`, `usePathname` from `@/i18n/navigation`.
    - Import `useLocale` from `next-intl`.
    - Render a `<Button variant="ghost" size="sm">` showing current locale code (EN / BG).
    - On click, switch locale: `router.replace(pathname, { locale: nextLocale })`.
    - Use `routing.locales` to determine the other locale.
    - Display as a simple toggle button: "EN" when viewing English, clicking switches to BG and vice versa. Keep it minimal (not a dropdown) since there are only 2 languages.
  </action>
  <verify>
    Run `cd /home/rosen/fiberq/web && npx tsc --noEmit` -- no type errors.
    Run `npm run build` -- should complete without errors.
    Verify `src/app/[locale]/layout.tsx` contains `<SidebarProvider>` and `<AppSidebar`.
    Verify `src/components/sidebar-nav.tsx` imports `filterNavByRole` from `@/lib/roles`.
    Verify `src/components/user-nav.tsx` contains `signOut`.
    Verify `src/components/theme-toggle.tsx` imports `useTheme`.
    Verify `src/components/language-switcher.tsx` uses `router.replace` for locale switching.
  </verify>
  <done>
    Complete app shell with: collapsible sidebar (icons on tablet, sheet on mobile, full on desktop), role-filtered navigation, user avatar dropdown with profile link and sign out, theme toggle (light/dark/system), BG/EN language switcher, FiberQ logo in sidebar header. All text uses i18n keys. Green/teal theme applied.
  </done>
</task>

</tasks>

<verification>
1. `cd /home/rosen/fiberq/web && npm run build` succeeds
2. `npx tsc --noEmit` shows no type errors
3. Sidebar renders with correct nav items based on user roles
4. Theme toggle switches between light/dark/system
5. Language switcher toggles between EN and BG
6. Sidebar collapses to icons (verify CSS class `data-[collapsible=icon]` is used)
7. Root page redirects admin to `/users` and others to `/projects`
</verification>

<success_criteria>
- Authenticated users see the sidebar shell with navigation items filtered by their roles
- Admin sees Dashboard, Projects, Users, Profile; non-admin does not see Users
- Sidebar collapses to icons on tablet (768-1023px) and shows as Sheet on mobile (<768px)
- Theme follows system preference with manual override available
- Language switches between Bulgarian and English
- FiberQ logo and name visible in sidebar header (name hidden when collapsed)
- Green/teal color palette applied consistently in light and dark modes
- Data-dense typography (14px base, tight line-height)
- Root page redirects to role-appropriate default page
</success_criteria>

<output>
After completion, create `.planning/phases/01-auth-foundation-app-shell/01-02-SUMMARY.md`
</output>
