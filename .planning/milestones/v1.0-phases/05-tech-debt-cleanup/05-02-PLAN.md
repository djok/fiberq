---
phase: 05-tech-debt-cleanup
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - server/api/projects/routes.py
  - web/src/app/[locale]/projects/_actions.ts
  - web/src/app/[locale]/projects/_components/project-detail-actions.tsx
  - web/src/messages/en.json
  - web/src/messages/bg.json
autonomous: true

must_haves:
  truths:
    - "Assignable users list includes all Kanidm persons, not just those who have logged in"
    - "Admin or PM can delete a project from the project detail page with a confirmation dialog"
    - "After deleting a project, the user is redirected to the projects list"
  artifacts:
    - path: "server/api/projects/routes.py"
      provides: "Kanidm-backed assignable users endpoint"
      contains: "kanidm"
    - path: "web/src/app/[locale]/projects/_actions.ts"
      provides: "deleteProject server action"
      contains: "deleteProject"
    - path: "web/src/app/[locale]/projects/_components/project-detail-actions.tsx"
      provides: "Delete button with confirmation dialog"
      contains: "ConfirmActionDialog"
  key_links:
    - from: "server/api/projects/routes.py"
      to: "KanidmAdminClient.list_persons()"
      via: "kanidm_client import"
      pattern: "kanidm.*list_persons"
    - from: "web/src/app/[locale]/projects/_components/project-detail-actions.tsx"
      to: "web/src/app/[locale]/projects/_actions.ts"
      via: "deleteProject import"
      pattern: "import.*deleteProject.*from.*_actions"
    - from: "web/src/app/[locale]/projects/_actions.ts"
      to: "DELETE /projects/{id}"
      via: "apiFetch with DELETE method"
      pattern: "apiFetch.*projects.*DELETE"
---

<objective>
Fix assignable users to source from Kanidm instead of user_logins, and add project delete UI with confirmation dialog on the project detail page.

Purpose: Close the remaining 2 tech debt items from the v1 milestone audit -- the two that require actual code changes (not just file operations).
Output: Kanidm-backed assignable users endpoint, working delete project button with confirmation.
</objective>

<execution_context>
@/home/rosen/.claude/get-shit-done/workflows/execute-plan.md
@/home/rosen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/v1-MILESTONE-AUDIT.md

@server/api/projects/routes.py
@server/api/users/kanidm_client.py
@server/api/users/routes.py
@web/src/app/[locale]/projects/_actions.ts
@web/src/app/[locale]/projects/_components/project-detail-actions.tsx
@web/src/app/[locale]/users/_components/user-detail-actions.tsx
@web/src/app/[locale]/users/_components/confirm-action-dialog.tsx
@web/src/messages/en.json
@web/src/messages/bg.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix assignable users to source from Kanidm</name>
  <files>server/api/projects/routes.py</files>
  <action>
    Rewrite the `list_assignable_users` endpoint (around line 626-650 in `server/api/projects/routes.py`) to fetch users from Kanidm instead of the user_logins table.

    **Reference pattern:** `server/api/users/routes.py` lines 77-106 already does this exact thing in `list_users()`:
    - Instantiates `KanidmAdminClient` via `_get_kanidm_client()` factory
    - Calls `kanidm.list_persons()`
    - Parses `attrs` from each person entry
    - Filters out service accounts and system entries

    **Implementation:**

    1. Add imports at the top of `server/api/projects/routes.py`:
       ```python
       from users.kanidm_client import KanidmAdminClient
       import httpx
       ```

    2. Add a local factory function (same pattern as users/routes.py):
       ```python
       def _get_kanidm_client() -> KanidmAdminClient:
           return KanidmAdminClient()
       ```

    3. Replace the `list_assignable_users` function body. The new implementation should:
       - Call `kanidm.list_persons()` to get all Kanidm persons
       - Filter out service accounts (`"service_account" in classes`) and system entries (`username in ("anonymous",)` or `username.startswith("admin@")`)
       - Extract `spn` (or first value of `name` attr) as `user_sub`
       - Extract `displayname` as `display_name`
       - Extract `mail` as `email` (first value or None)
       - Return list of `{"user_sub": ..., "display_name": ..., "email": ...}` matching existing frontend contract
       - Wrap in try/except for `httpx.HTTPStatusError` returning 502

    **Critical: Keep the same response shape** -- the frontend `fetchAssignableUsers()` in `_actions.ts` expects `{user_sub, display_name, email}` objects. Do NOT change the response contract.

    **The `spn` attribute** contains the user's unique ID in format `username@domain`. This is what gets stored as `user_sub` in the system (it matches what Auth.js receives in the `sub` claim). Use `attrs.get("spn", [""])[0]` for user_sub.

    Look at how `_parse_person()` in `server/api/users/routes.py` extracts the spn to confirm the attribute path.
  </action>
  <verify>
    Run `python -c "import ast; ast.parse(open('server/api/projects/routes.py').read())"` to confirm valid Python syntax.
    Run `grep -n "kanidm" server/api/projects/routes.py` to confirm Kanidm client is used.
    Run `grep -n "user_logins" server/api/projects/routes.py` to confirm old query is removed (should return 0 results in the assignable-users function).
  </verify>
  <done>
    The assignable-users endpoint fetches persons from Kanidm via `list_persons()`, filters system accounts, and returns the same `{user_sub, display_name, email}` shape. Newly admin-created users appear in the list without requiring a first login.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add project delete button with confirmation dialog</name>
  <files>
    web/src/app/[locale]/projects/_actions.ts
    web/src/app/[locale]/projects/_components/project-detail-actions.tsx
    web/src/messages/en.json
    web/src/messages/bg.json
  </files>
  <action>
    Add a Delete Project button to the project detail page actions card, using the existing backend DELETE endpoint and the established ConfirmActionDialog pattern.

    **Step 1: Add `deleteProject` server action to `_actions.ts`**

    Add a new exported async function following the existing pattern (updateProject, assignMember, etc.):
    ```typescript
    export async function deleteProject(
      projectId: number,
    ): Promise<ActionResult> {
      try {
        await apiFetch(`/projects/${projectId}`, {
          method: "DELETE",
        });
        revalidatePath("/[locale]/projects");
        return { success: true, data: undefined };
      } catch (e) {
        return {
          success: false,
          error: e instanceof Error ? e.message : "Failed to delete project",
        };
      }
    }
    ```

    **Step 2: Update `project-detail-actions.tsx` to add delete button and dialog**

    Follow the pattern from `user-detail-actions.tsx` (Phase 2) which uses ConfirmActionDialog for destructive actions:

    1. Add imports:
       ```typescript
       import { useRouter } from "next/navigation";
       import { toast } from "sonner";
       import { ConfirmActionDialog } from "@/app/[locale]/users/_components/confirm-action-dialog";
       import { deleteProject } from "../_actions";
       ```

    2. Add state variables inside the component:
       ```typescript
       const router = useRouter();
       const [showDeleteDialog, setShowDeleteDialog] = React.useState(false);
       const [deleteLoading, setDeleteLoading] = React.useState(false);
       ```

    3. Add the delete handler function:
       ```typescript
       async function handleDeleteProject() {
         setDeleteLoading(true);
         try {
           const result = await deleteProject(project.id);
           if (result.success) {
             toast.success(t("deleteSuccess"));
             router.push(`/${locale}/projects`);
           } else {
             toast.error(t("deleteError"), { description: result.error });
           }
         } finally {
           setDeleteLoading(false);
           setShowDeleteDialog(false);
         }
       }
       ```

    4. Add a Delete Project button BELOW the Edit Project button inside the Actions Card, using destructive variant:
       ```tsx
       <Button
         variant="destructive"
         className="w-full"
         onClick={() => setShowDeleteDialog(true)}
       >
         {t("deleteProject")}
       </Button>
       ```

    5. Add the ConfirmActionDialog AFTER the EditProjectDialog at the bottom of the JSX return:
       ```tsx
       <ConfirmActionDialog
         open={showDeleteDialog}
         onOpenChange={setShowDeleteDialog}
         title={t("confirmDeleteTitle")}
         description={t("confirmDeleteDescription", { name: project.name })}
         confirmLabel={t("deleteProject")}
         onConfirm={handleDeleteProject}
         variant="destructive"
         loading={deleteLoading}
       />
       ```

    6. Note: The `locale` prop is already in `ProjectDetailActionsProps` but currently destructured out. Make sure to add it to the destructured props: `{ project, canManage, locale }`.

    **Step 3: Add i18n keys to both en.json and bg.json**

    In the `"projects"` section of `web/src/messages/en.json`, add:
    ```json
    "deleteProject": "Delete Project",
    "confirmDeleteTitle": "Delete Project",
    "confirmDeleteDescription": "Are you sure you want to delete \"{name}\"? This action cannot be undone. All project data, member assignments, and activity history will be permanently removed.",
    "deleteSuccess": "Project deleted successfully",
    "deleteError": "Failed to delete project"
    ```

    In the `"projects"` section of `web/src/messages/bg.json`, add the Bulgarian translations:
    ```json
    "deleteProject": "Изтриване на проект",
    "confirmDeleteTitle": "Изтриване на проект",
    "confirmDeleteDescription": "Сигурни ли сте, че искате да изтриете \"{name}\"? Това действие не може да бъде отменено. Всички данни за проекта, назначения на членове и история на дейността ще бъдат окончателно премахнати.",
    "deleteSuccess": "Проектът е изтрит успешно",
    "deleteError": "Неуспешно изтриване на проекта"
    ```

    **Key details:**
    - The delete button is only visible when `canManage` is true (already gated by the Actions Card conditional)
    - Backend DELETE endpoint at `server/api/projects/routes.py` line 512 already exists with `require_project_manager_or_admin`
    - After successful delete, redirect to projects list page (not stay on now-deleted detail page)
    - ConfirmActionDialog is imported from `@/app/[locale]/users/_components/confirm-action-dialog` (cross-module import, same pattern as Phase 3 member removal)
  </action>
  <verify>
    Run `cd /home/rosen/fiberq/web && npx tsc --noEmit` to confirm TypeScript compiles clean.
    Run `grep -n "deleteProject" web/src/app/[locale]/projects/_actions.ts` to confirm server action exists.
    Run `grep -n "ConfirmActionDialog" web/src/app/[locale]/projects/_components/project-detail-actions.tsx` to confirm dialog is wired.
    Run `grep -n "deleteProject" web/src/messages/en.json` to confirm i18n key exists.
    Run `grep -n "deleteProject" web/src/messages/bg.json` to confirm Bulgarian translation exists.
  </verify>
  <done>
    Delete Project button appears in the Actions card on project detail page (visible to admin/PM only). Clicking shows a confirmation dialog with project name. Confirming calls DELETE /projects/{id} via server action, shows success toast, and redirects to projects list. Both EN and BG translations are present.
  </done>
</task>

</tasks>

<verification>
1. `grep -rn "user_logins" server/api/projects/routes.py` returns 0 results in the assignable-users function (Kanidm is now the source)
2. `grep -n "kanidm" server/api/projects/routes.py` confirms Kanidm client usage
3. `grep -n "deleteProject" web/src/app/[locale]/projects/_actions.ts` confirms server action
4. `grep -n "ConfirmActionDialog" web/src/app/[locale]/projects/_components/project-detail-actions.tsx` confirms dialog wired
5. TypeScript compilation succeeds (`npx tsc --noEmit` in web/)
6. Both en.json and bg.json have delete-related i18n keys in the projects section
</verification>

<success_criteria>
- Assignable users list includes all Kanidm persons (not just logged-in users)
- Response shape unchanged: `{user_sub, display_name, email}` -- frontend fetchAssignableUsers works without changes
- Delete button visible on project detail page for admin/PM users
- Confirmation dialog shown before deletion with project name
- Successful deletion redirects to projects list with success toast
- Both English and Bulgarian translations present
- Zero compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-tech-debt-cleanup/05-02-SUMMARY.md`
</output>
