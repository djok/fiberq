---
phase: 05-tech-debt-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - web/src/middleware.ts
  - web/src/proxy.ts
  - server/api/dependencies.py
  - web/src/app/[locale]/dashboard/page.tsx
autonomous: true

must_haves:
  truths:
    - "Next.js middleware executes at Edge level, protecting all routes before layout rendering"
    - "server/api/dependencies.py no longer exists in the codebase"
    - "dashboard/page.tsx has an explicit auth() check matching the per-page pattern"
  artifacts:
    - path: "web/src/middleware.ts"
      provides: "Edge-level auth + i18n middleware"
      contains: "export default auth"
    - path: "web/src/app/[locale]/dashboard/page.tsx"
      provides: "Dashboard page with auth guard"
      contains: "await auth()"
  key_links:
    - from: "web/src/middleware.ts"
      to: "Next.js Edge runtime"
      via: "Convention-based file name"
      pattern: "export default.*export const config"
    - from: "web/src/app/[locale]/dashboard/page.tsx"
      to: "@/auth"
      via: "auth() import and redirect"
      pattern: "import.*auth.*from.*@/auth"
---

<objective>
Fix three quick tech debt items: rename proxy.ts to middleware.ts so Next.js loads it as Edge middleware, delete the orphaned dependencies.py dead code file, and add the missing auth() check to dashboard/page.tsx.

Purpose: Close 3 of 5 tech debt items from the v1 milestone audit -- the three that are simple file-level fixes with no behavioral changes.
Output: Properly named middleware file, removed dead code, consistent auth pattern on dashboard page.
</objective>

<execution_context>
@/home/rosen/.claude/get-shit-done/workflows/execute-plan.md
@/home/rosen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/v1-MILESTONE-AUDIT.md

@web/src/proxy.ts
@server/api/dependencies.py
@web/src/app/[locale]/dashboard/page.tsx
@web/src/app/[locale]/projects/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rename proxy.ts to middleware.ts</name>
  <files>web/src/proxy.ts, web/src/middleware.ts</files>
  <action>
    Rename `web/src/proxy.ts` to `web/src/middleware.ts` using `git mv` to preserve history.

    The file content stays EXACTLY the same -- no code changes needed. The file already has:
    - `export default auth(...)` wrapping the handler function
    - `export const config = { matcher: ... }` for route matching
    - Auth-before-i18n composition (correct ordering)

    Next.js requires the file to be named `middleware.ts` (or `.js`) at the `src/` root to load it as Edge middleware. Currently named `proxy.ts`, so Next.js ignores it entirely.

    After rename, verify no other file imports from `@/proxy` or `./proxy` -- the file is loaded by Next.js convention, not imports. The codebase has zero import references to proxy.ts.

    Update the JSDoc comment inside the function: change "Next.js 16 proxy" to "Next.js 16 middleware" for consistency with the new file name. Change the function name from `proxy` to `middleware` in the `auth()` wrapper call.
  </action>
  <verify>
    Run `git status` to confirm proxy.ts is renamed to middleware.ts.
    Run `grep -r "proxy" web/src/middleware.ts` to confirm function name and comment updated.
    Run `grep -rn "from.*proxy" web/src/` to confirm no broken imports (should return 0 results).
    Run `cd /home/rosen/fiberq/web && npx next build 2>&1 | head -30` or `npx tsc --noEmit` to confirm TypeScript compilation succeeds.
  </verify>
  <done>
    web/src/middleware.ts exists with identical logic to the old proxy.ts. web/src/proxy.ts no longer exists. No broken imports. TypeScript compiles clean.
  </done>
</task>

<task type="auto">
  <name>Task 2: Delete dependencies.py dead code</name>
  <files>server/api/dependencies.py</files>
  <action>
    Delete `server/api/dependencies.py` using `git rm`.

    This 31-line file contains three hardcoded role-check functions (require_admin, require_engineer, require_field_worker) that are completely superseded by `server/api/auth/roles.py` which provides a flexible factory function `require_role(*allowed_roles)`.

    Before deleting, verify no file imports from it:
    - Run `grep -rn "from dependencies" server/api/` -- should return 0 results
    - Run `grep -rn "import dependencies" server/api/` -- should return 0 results

    The active implementation lives at `server/api/auth/roles.py` (25 lines, factory pattern). No code changes needed anywhere else.
  </action>
  <verify>
    Run `grep -rn "dependencies" server/api/ --include="*.py"` to confirm no remaining references (only hits should be in unrelated context like "Depends" from FastAPI).
    Run `ls server/api/dependencies.py 2>&amp;1` confirms file does not exist.
  </verify>
  <done>
    server/api/dependencies.py is deleted. No import references existed. The codebase uses auth/roles.py exclusively for role checks.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add auth() check to dashboard page</name>
  <files>web/src/app/[locale]/dashboard/page.tsx</files>
  <action>
    Add the standard per-page auth guard to `web/src/app/[locale]/dashboard/page.tsx`.

    Follow the exact pattern used in other pages (projects/page.tsx line 40, users/page.tsx line 44, profile/page.tsx line 14):

    1. Add imports at the top:
       ```typescript
       import { auth } from "@/auth";
       import { redirect } from "next/navigation";
       ```

    2. Add auth check as the first lines inside the async function body, AFTER the `const { locale } = await params;` and `setRequestLocale(locale);` lines:
       ```typescript
       const session = await auth();
       if (!session) {
         redirect(`/${locale}/api/auth/signin`);
       }
       ```

    Keep all existing imports and JSX unchanged. The page is already a Server Component (no "use client" directive), so `auth()` works directly.

    Note: The page is currently protected by the layout-level guard, so this is a consistency fix to match the per-page pattern, not a security fix.
  </action>
  <verify>
    Run `grep -n "await auth()" web/src/app/[locale]/dashboard/page.tsx` to confirm auth check present.
    Run `cd /home/rosen/fiberq/web && npx tsc --noEmit` to confirm TypeScript compiles clean.
  </verify>
  <done>
    dashboard/page.tsx has `const session = await auth()` followed by redirect guard, matching the pattern in projects/page.tsx, users/page.tsx, and profile/page.tsx.
  </done>
</task>

</tasks>

<verification>
1. `web/src/middleware.ts` exists, `web/src/proxy.ts` does not exist
2. `server/api/dependencies.py` does not exist
3. `web/src/app/[locale]/dashboard/page.tsx` contains `await auth()` and `redirect` guard
4. TypeScript compilation succeeds (`npx tsc --noEmit` in web/)
5. No broken imports across the codebase
</verification>

<success_criteria>
- Next.js will load middleware.ts at Edge level (verified by file existence at correct path with correct name)
- Dead code file is removed from version control
- Dashboard page auth pattern matches all other protected pages
- Zero compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-tech-debt-cleanup/05-01-SUMMARY.md`
</output>
