---
phase: 04-dashboard-analytics
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - web/src/types/project.ts
  - web/src/app/[locale]/projects/_actions.ts
  - web/src/app/[locale]/projects/_components/stat-tile.tsx
  - web/src/app/[locale]/projects/_components/project-stats.tsx
  - web/src/app/[locale]/projects/_components/activity-timeline.tsx
  - web/src/app/[locale]/projects/_components/project-activity.tsx
  - web/src/app/[locale]/projects/[id]/page.tsx
  - web/src/messages/en.json
  - web/src/messages/bg.json
autonomous: true

must_haves:
  truths:
    - "Project detail page displays stat tiles with closures, poles, cables, cable length, team size, and last sync metrics"
    - "Stat tiles show em-dash when no data exists, actual numbers when data is present"
    - "Last sync tile shows relative time as main text with exact date on tooltip hover"
    - "Delta indicator shows features uploaded from last sync (e.g., +42) when available"
    - "Activity feed shows entries grouped by day (Today, Yesterday, formatted date) in reverse chronological order"
    - "Activity feed shows sync uploads, member assignments, and status changes with distinct icons and colors"
    - "Load more button fetches older entries via cursor-based pagination"
    - "Empty activity feed shows friendly icon + message instead of blank space"
    - "All text is bilingual (BG + EN)"
  artifacts:
    - path: "web/src/app/[locale]/projects/_components/stat-tile.tsx"
      provides: "Reusable stat card with icon, label, value, optional delta"
      min_lines: 20
    - path: "web/src/app/[locale]/projects/_components/project-stats.tsx"
      provides: "Grid of 6 stat tiles with data mapping"
      min_lines: 30
    - path: "web/src/app/[locale]/projects/_components/activity-timeline.tsx"
      provides: "Vertical timeline rendering with day grouping, event icons, colors"
      min_lines: 40
    - path: "web/src/app/[locale]/projects/_components/project-activity.tsx"
      provides: "Client component wrapping timeline with load-more state management"
      min_lines: 30
    - path: "web/src/app/[locale]/projects/[id]/page.tsx"
      provides: "Restructured detail page with stats + activity integrated"
      min_lines: 60
  key_links:
    - from: "web/src/app/[locale]/projects/[id]/page.tsx"
      to: "/api/projects/{id}/stats"
      via: "apiFetch in Server Component"
      pattern: "apiFetch.*stats"
    - from: "web/src/app/[locale]/projects/[id]/page.tsx"
      to: "/api/projects/{id}/activity"
      via: "apiFetch in Server Component"
      pattern: "apiFetch.*activity"
    - from: "web/src/app/[locale]/projects/_components/project-activity.tsx"
      to: "web/src/app/[locale]/projects/_actions.ts"
      via: "fetchActivity server action for load-more"
      pattern: "fetchActivity"
    - from: "web/src/app/[locale]/projects/_components/project-stats.tsx"
      to: "web/src/app/[locale]/projects/_components/stat-tile.tsx"
      via: "StatTile component import"
      pattern: "StatTile"
---

<objective>
Build the stat tiles and activity feed UI on the project detail page.

Purpose: Give users at-a-glance project health (element counts, team size, last sync) and a chronological feed of recent project activity (syncs, assignments, status changes) -- all integrated into the existing project detail page from Phase 3.
Output: 4 new components (StatTile, ProjectStats, ActivityTimeline, ProjectActivity), restructured detail page layout, fetchActivity server action, bilingual i18n messages.
</objective>

<execution_context>
@/home/rosen/.claude/get-shit-done/workflows/execute-plan.md
@/home/rosen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-dashboard-analytics/04-RESEARCH.md
@.planning/phases/04-dashboard-analytics/04-01-SUMMARY.md
@.planning/phases/03-project-management-assignment/03-03-SUMMARY.md

@web/src/app/[locale]/projects/[id]/page.tsx
@web/src/app/[locale]/projects/_actions.ts
@web/src/app/[locale]/projects/_components/project-detail-actions.tsx
@web/src/types/project.ts
@web/src/messages/en.json
@web/src/messages/bg.json
@web/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add types, server action, and presentational components (StatTile, ActivityTimeline)</name>
  <files>web/src/types/project.ts, web/src/app/[locale]/projects/_actions.ts, web/src/app/[locale]/projects/_components/stat-tile.tsx, web/src/app/[locale]/projects/_components/activity-timeline.tsx, web/src/messages/en.json, web/src/messages/bg.json</files>
  <action>
**A) Types** -- In web/src/types/project.ts, add:

```typescript
export type ProjectStats = {
  closures: number | null;
  poles: number | null;
  cables: number | null;
  cableLengthM: number | null;
  teamSize: number;
  lastSyncAt: string | null;
  lastSyncFeatures: number | null;
};

export type ActivityEntry = {
  eventType: string; // 'sync_upload' | 'member_assigned' | 'status_change' | 'member_removed'
  eventAt: string;
  userSub: string | null;
  userDisplayName: string | null;
  details: Record<string, unknown> | null;
};

export type ActivityPage = {
  entries: ActivityEntry[];
  hasMore: boolean;
};
```

**B) Server action** -- In web/src/app/[locale]/projects/_actions.ts, add a fetchActivity server action:

```typescript
type ApiActivityEntry = {
  event_type: string;
  event_at: string;
  user_sub: string | null;
  user_display_name: string | null;
  details: Record<string, unknown> | null;
};

type ApiActivityPage = {
  entries: ApiActivityEntry[];
  has_more: boolean;
};

export async function fetchActivity(
  projectId: number,
  before?: string,
): Promise<ActionResult<ActivityPage>> {
  try {
    const url = before
      ? `/projects/${projectId}/activity?limit=20&before=${before}`
      : `/projects/${projectId}/activity?limit=20`;
    const data = await apiFetch<ApiActivityPage>(url);
    return {
      success: true,
      data: {
        entries: data.entries.map((e) => ({
          eventType: e.event_type,
          eventAt: e.event_at,
          userSub: e.user_sub,
          userDisplayName: e.user_display_name,
          details: e.details,
        })),
        hasMore: data.has_more,
      },
    };
  } catch (e) {
    return {
      success: false,
      error: e instanceof Error ? e.message : "Failed to fetch activity",
    };
  }
}
```

Import ActivityPage from @/types/project.

**C) StatTile component** -- Create web/src/app/[locale]/projects/_components/stat-tile.tsx:

A server-compatible presentational component (no "use client" needed since parent controls interactivity). Props: icon (ReactNode), label (string), value (number | string | null), delta (number | null | undefined), formatValue (optional function). Renders a shadcn Card with:
- Left: icon in a 10x10 rounded-lg div with bg-primary/10 text-primary
- Right: label as text-sm text-muted-foreground, value as text-2xl font-bold (show "\u2014" em-dash when value is null), delta below value as text-xs with green for positive (+N) and red for negative, hidden when delta is 0/null/undefined.

The "last sync" tile value is a string (relative time), not a number. So value prop must accept number | string | null. When value is a string, render it directly. When value is a number, apply formatValue if provided, otherwise render as-is.

**D) ActivityTimeline component** -- Create web/src/app/[locale]/projects/_components/activity-timeline.tsx:

Presentational component rendering a list of ActivityEntry objects grouped by day. Props: entries (ActivityEntry[]), locale (string), translations (record of translated strings for "today", "yesterday", event descriptions).

Structure:
- Group entries by day using date comparison (today, yesterday, or formatted date via toLocaleDateString)
- For each day group: render a day header with CalendarDays icon in a bordered circle + day label text
- For each entry within a group: render a timeline item with:
  - Vertical line: absolute positioned div (left-4, w-px, bg-border) running the full height
  - Event icon circle: 8x8 rounded-full with color based on event_type:
    - sync_upload: Upload icon, blue bg (bg-blue-100 dark:bg-blue-900/30, text-blue-600 dark:text-blue-400)
    - member_assigned: UserPlus icon, green bg
    - member_removed: UserMinus icon, red bg
    - status_change: ArrowRightLeft icon, amber bg
  - Event text: descriptive message built from event_type and details. Examples:
    - sync_upload: "{user} uploaded {features_uploaded} features"
    - member_assigned: "{member_name} assigned as {project_role}"
    - member_removed: "{member_name} removed"
    - status_change: "Status changed from {old_status} to {new_status}"
  - Timestamp: time portion (HH:MM) in text-xs text-muted-foreground

Use lucide-react icons: Upload, UserPlus, UserMinus, ArrowRightLeft, CalendarDays.

**E) i18n messages** -- Add a "dashboard" namespace to both en.json and bg.json:

EN:
```json
"dashboard": {
  "closures": "Closures",
  "poles": "Poles",
  "cables": "Cables",
  "cableLength": "Cable Length",
  "teamSize": "Team Size",
  "lastSync": "Last Sync",
  "today": "Today",
  "yesterday": "Yesterday",
  "loadMore": "Load more",
  "noActivity": "No activity yet",
  "noActivityDescription": "Activity will appear here as the project progresses.",
  "syncUpload": "{user} uploaded {count} features",
  "memberAssigned": "{member} assigned as {role}",
  "memberRemoved": "{member} removed",
  "statusChanged": "Status changed from {from} to {to}",
  "features": "features",
  "unknownUser": "System"
}
```

BG:
```json
"dashboard": {
  "closures": "Муфи",
  "poles": "Стълбове",
  "cables": "Кабели",
  "cableLength": "Дължина кабели",
  "teamSize": "Екип",
  "lastSync": "Последен синхр.",
  "today": "Днес",
  "yesterday": "Вчера",
  "loadMore": "Зареди още",
  "noActivity": "Няма активност",
  "noActivityDescription": "Тук ще се показва активността на проекта.",
  "syncUpload": "{user} качи {count} обекта",
  "memberAssigned": "{member} добавен като {role}",
  "memberRemoved": "{member} премахнат",
  "statusChanged": "Статус сменен от {from} на {to}",
  "features": "обекта",
  "unknownUser": "Система"
}
```
  </action>
  <verify>
1. `npx tsc --noEmit` passes (or at minimum no errors in the new/modified files)
2. StatTile renders without "use client" (server-compatible)
3. ActivityTimeline renders a vertical line + icon circles from mock data
4. fetchActivity action is properly typed and follows existing ActionResult pattern
5. Both en.json and bg.json parse as valid JSON
  </verify>
  <done>ProjectStats/ActivityEntry/ActivityPage types defined. fetchActivity server action follows discriminated union pattern. StatTile renders icon+label+value+delta. ActivityTimeline renders day-grouped vertical timeline with colored event icons. All dashboard i18n keys present in both locales.</done>
</task>

<task type="auto">
  <name>Task 2: Build ProjectStats grid, ProjectActivity client wrapper, and restructure detail page</name>
  <files>web/src/app/[locale]/projects/_components/project-stats.tsx, web/src/app/[locale]/projects/_components/project-activity.tsx, web/src/app/[locale]/projects/[id]/page.tsx</files>
  <action>
**A) ProjectStats component** -- Create web/src/app/[locale]/projects/_components/project-stats.tsx:

Server component (no "use client"). Props: stats (ProjectStats from types), lastSyncRelative (string | null -- pre-formatted by parent), lastSyncExact (string | null -- for tooltip).

Renders a responsive grid: `grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4` with 6 StatTile instances:
1. Closures: Box icon, label from t("dashboard.closures"), value=stats.closures
2. Poles: Zap icon, label from t("dashboard.poles"), value=stats.poles
3. Cables: Cable icon, label from t("dashboard.cables"), value=stats.cables
4. Cable Length: Ruler icon, label from t("dashboard.cableLength"), value=stats.cableLengthM, formatValue to show "X.X km" (divide by 1000) or "X m" if under 1000
5. Team Size: Users icon, label from t("dashboard.teamSize"), value=stats.teamSize (never null)
6. Last Sync: Clock icon, label from t("dashboard.lastSync"), value=lastSyncRelative (string). Delta=stats.lastSyncFeatures (shows "+N" features from last sync).

For the Last Sync tile: wrap the value in a Tooltip (from @/components/ui/tooltip) that shows lastSyncExact on hover. Since this is a Server Component, use TooltipProvider/Tooltip/TooltipTrigger/TooltipContent from shadcn. If lastSyncRelative is null, StatTile receives null and shows em-dash.

Accept translations via `t` from next-intl/server (getTranslations in the parent page passes t as prop, OR this component calls getTranslations itself). Prefer: have this component accept a `translations` record prop with pre-resolved labels, to keep it pure presentational. Or, since it's a Server Component, it can use `getTranslations` directly -- choose whichever is simpler.

**B) ProjectActivity client component** -- Create web/src/app/[locale]/projects/_components/project-activity.tsx:

"use client" component. Props: projectId (number), initialEntries (ActivityEntry[]), initialHasMore (boolean), locale (string).

State: entries (ActivityEntry[]), hasMore (boolean), loading (boolean).

Renders:
- A Card with CardHeader title (t("dashboard") would need useTranslations -- or accept title as prop). Use "Activity" / activity title from i18n.
- CardContent containing:
  - If entries is empty: empty state with an InboxIcon (from lucide) centered, muted text with "No activity yet" message and description from i18n
  - If entries exist: ActivityTimeline component with current entries and locale
  - If hasMore: a "Load more" Button (variant="outline", size="sm", full width) at the bottom. On click: call fetchActivity server action with projectId and before=last entry's eventAt timestamp. On success: append new entries to state, update hasMore. Show loading spinner on button while fetching.

**C) Restructure project detail page** -- Modify web/src/app/[locale]/projects/[id]/page.tsx:

Major changes:
1. Import new components: ProjectStats, ProjectActivity
2. Import apiFetch types for stats and activity API responses
3. Add API types for stats and activity:
```typescript
type ApiProjectStats = {
  closures: number | null;
  poles: number | null;
  cables: number | null;
  cable_length_m: number | null;
  team_size: number;
  last_sync_at: string | null;
  last_sync_features: number | null;
};

type ApiActivityPage = {
  entries: Array<{
    event_type: string;
    event_at: string;
    user_sub: string | null;
    user_display_name: string | null;
    details: Record<string, unknown> | null;
  }>;
  has_more: boolean;
};
```

4. Fetch stats and initial activity in parallel with existing project data:
```typescript
const [projectData, statsData, activityData] = await Promise.all([
  apiFetch<ApiProjectDetail>(`/projects/${id}`),
  apiFetch<ApiProjectStats>(`/projects/${id}/stats`),
  apiFetch<ApiActivityPage>(`/projects/${id}/activity?limit=20`),
]);
```

Wrap stats and activity fetches in try/catch individually -- if they fail, default to null/empty (don't block the page). The project fetch failure still triggers notFound() as before.

5. Map snake_case to camelCase for stats:
```typescript
const stats: ProjectStats | null = statsData ? {
  closures: statsData.closures,
  poles: statsData.poles,
  cables: statsData.cables,
  cableLengthM: statsData.cable_length_m,
  teamSize: statsData.team_size,
  lastSyncAt: statsData.last_sync_at,
  lastSyncFeatures: statsData.last_sync_features,
} : null;
```

6. Map activity entries similarly.

7. Compute relative time for last sync using next-intl/server:
```typescript
import { getFormatter, getNow } from "next-intl/server";
const format = await getFormatter();
const now = await getNow();
const lastSyncRelative = stats?.lastSyncAt
  ? format.relativeTime(new Date(stats.lastSyncAt), now)
  : null;
const lastSyncExact = stats?.lastSyncAt
  ? format.dateTime(new Date(stats.lastSyncAt), { dateStyle: "medium", timeStyle: "short" })
  : null;
```

8. Restructure the layout to match research recommendation:

```
[Header: Back link + Project Name + Status Badge]  -- unchanged
[Stat Tiles Grid - full width, 6 columns on lg]    -- NEW
[Left Column 2/3]              [Right Column 1/3]
  [Map Card]                     [Members Card]
  [Activity Feed Card]           [Actions Card]
```

The stat tiles row goes ABOVE the existing grid (full width, not inside the 3-column grid). Below that, the existing grid stays but with Activity Feed added as a new Card in the left column below the existing Map and Project Info cards. Remove or keep the Project Info card per your judgment -- the stat tiles now show the key metrics so the Project Info card is somewhat redundant but still shows description and creation date.

Keep the Project Info card but simplify it (keep description and createdAt, remove the duplicated name and status since they're in the header).

Pass stats, activity data, and locale/time formatting to the new components.
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. Navigate to a project detail page -- stat tiles appear above the main content grid
3. Stat tiles show em-dash for projects with no synced data, numbers for projects with data
4. Last sync tile shows relative time with tooltip on hover
5. Activity feed appears below the map in the left column
6. Empty activity feed shows friendly empty state message
7. "Load more" button fetches older entries if available
8. Switching locale (BG/EN) translates all dashboard labels
  </verify>
  <done>Project detail page displays 6 stat tiles (closures, poles, cables, cable length, team size, last sync) in a responsive grid. Tiles show em-dash for missing data, delta indicator for last sync features. Activity feed renders vertical timeline with day grouping, colored event icons, and "load more" pagination. All text bilingual.</done>
</task>

</tasks>

<verification>
- Project detail page loads without errors with both populated and empty project data
- Stats endpoint data correctly mapped and displayed in tiles
- Activity feed shows entries from all three sources (sync, assignments, status changes)
- Cursor-based pagination works (load more fetches older entries)
- No hydration mismatch warnings (relative time rendered server-side only)
- Layout is responsive: 6-col stat grid on large screens, 2-col on mobile
- Both EN and BG translations work for all new UI text
</verification>

<success_criteria>
- DASH-01: Project detail page displays element counts, team size, and last sync timestamp from existing database tables
- DASH-02: Project detail page shows activity feed of recent actions in reverse chronological order
- Empty states handled gracefully (em-dash for stats, friendly message for feed)
- Load more pagination works for activity feed
- Bilingual (BG + EN) for all new text
</success_criteria>

<output>
After completion, create `.planning/phases/04-dashboard-analytics/04-02-SUMMARY.md`
</output>
