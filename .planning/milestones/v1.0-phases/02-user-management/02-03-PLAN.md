---
phase: 02-user-management
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - web/src/app/[locale]/users/[id]/page.tsx
  - web/src/app/[locale]/users/_components/user-actions.tsx
  - web/src/app/[locale]/users/_components/confirm-action-dialog.tsx
  - web/src/app/[locale]/users/_components/reset-token-dialog.tsx
  - web/src/app/[locale]/users/_components/edit-roles-dialog.tsx
  - web/src/app/[locale]/users/_components/columns.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can click a table row to navigate to /users/[id] detail page"
    - "Detail page shows profile data, roles, status, and a projects placeholder section"
    - "Admin can deactivate a user from the table actions dropdown, with confirmation dialog"
    - "Admin can reactivate an inactive user from the table actions dropdown"
    - "Admin can change a user's roles from the detail page via an edit roles dialog"
    - "Admin can trigger a password reset from the table actions dropdown, with confirmation, and sees the credential token"
    - "All destructive actions require confirmation dialogs"
    - "All action feedback is shown via toast notifications"
  artifacts:
    - path: "web/src/app/[locale]/users/[id]/page.tsx"
      provides: "User detail page with profile, roles, status, actions, projects placeholder"
      min_lines: 50
    - path: "web/src/app/[locale]/users/_components/user-actions.tsx"
      provides: "Dropdown menu with quick actions for table rows"
      contains: "UserActions"
    - path: "web/src/app/[locale]/users/_components/confirm-action-dialog.tsx"
      provides: "Reusable confirmation dialog for destructive actions"
      contains: "ConfirmActionDialog"
    - path: "web/src/app/[locale]/users/_components/edit-roles-dialog.tsx"
      provides: "Dialog for editing user role assignments"
      contains: "EditRolesDialog"
    - path: "web/src/app/[locale]/users/_components/reset-token-dialog.tsx"
      provides: "Dialog showing credential reset token with copy button"
      contains: "ResetTokenDialog"
  key_links:
    - from: "web/src/app/[locale]/users/_components/user-actions.tsx"
      to: "web/src/app/[locale]/users/_actions.ts"
      via: "server action calls"
      pattern: "(deactivateUser|reactivateUser|resetUserPassword)"
    - from: "web/src/app/[locale]/users/[id]/page.tsx"
      to: "web/src/lib/api.ts"
      via: "apiFetch to load single user"
      pattern: "apiFetch.*users"
    - from: "web/src/app/[locale]/users/_components/edit-roles-dialog.tsx"
      to: "web/src/app/[locale]/users/_actions.ts"
      via: "updateUserRoles server action"
      pattern: "updateUserRoles"
---

<objective>
Build the user detail page and all action components: table row actions dropdown (deactivate/reactivate, password reset), detail page with profile and roles display, edit roles dialog, and confirmation dialogs for destructive actions.

Purpose: This completes the user lifecycle management. Admins can perform all operations (deactivate, reactivate, change roles, reset password) from both the table and the detail page. Confirmation dialogs prevent accidental destructive actions. The detail page also prepares a projects placeholder section for Phase 3.

Output: Complete user management feature with all CRUD operations accessible and working.
</objective>

<execution_context>
@/home/rosen/.claude/get-shit-done/workflows/execute-plan.md
@/home/rosen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-user-management/02-RESEARCH.md
@.planning/phases/02-user-management/02-CONTEXT.md
@.planning/phases/02-user-management/02-02-SUMMARY.md
@web/src/app/[locale]/users/page.tsx
@web/src/app/[locale]/users/_actions.ts
@web/src/app/[locale]/users/_components/columns.tsx
@web/src/app/[locale]/users/_components/data-table.tsx
@web/src/types/user.ts
@web/src/messages/en.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: User actions dropdown, confirmation dialogs, and reset token dialog</name>
  <files>
    web/src/app/[locale]/users/_components/user-actions.tsx
    web/src/app/[locale]/users/_components/confirm-action-dialog.tsx
    web/src/app/[locale]/users/_components/reset-token-dialog.tsx
    web/src/app/[locale]/users/_components/columns.tsx
  </files>
  <action>
    **1. Create `web/src/app/[locale]/users/_components/confirm-action-dialog.tsx`** -- reusable confirmation dialog:

    "use client" directive. Props:
    - `open: boolean`
    - `onOpenChange: (open: boolean) => void`
    - `title: string`
    - `description: string`
    - `confirmLabel: string`
    - `onConfirm: () => void | Promise<void>`
    - `variant?: "default" | "destructive"` (default: "destructive")
    - `loading?: boolean`

    Uses shadcn AlertDialog (AlertDialogContent, not AlertDialogTrigger -- controlled by open prop):
    - Header with title and description
    - Footer with Cancel button and Confirm button
    - Confirm button uses `variant="destructive"` when variant is "destructive"
    - Show loading state on confirm button while action is pending

    **2. Create `web/src/app/[locale]/users/_components/reset-token-dialog.tsx`** -- dialog displaying credential reset token:

    "use client" directive. Props:
    - `open: boolean`
    - `onOpenChange: (open: boolean) => void`
    - `token: string`
    - `resetUrl: string`
    - `ttl: number` (seconds)

    Uses shadcn Dialog:
    - Title: translation key "users.resetTokenTitle"
    - Description: translation key "users.resetTokenDescription"
    - Token display: monospace font, large text, selectable, in a bordered box
    - Copy to clipboard button: onClick copies token, shows "Copied!" toast via sonner, button text changes briefly to "Copied!"
    - Reset URL display: clickable link (target="_blank") to the Kanidm reset page
    - Validity info: "Valid for {ttl/60} minutes"
    - Close button at bottom

    **3. Create `web/src/app/[locale]/users/_components/user-actions.tsx`** -- table row actions dropdown:

    "use client" directive. Props: `user: UserRow`.

    Uses shadcn DropdownMenu:
    - Trigger: Button with ellipsis icon (MoreHorizontal from lucide-react), `variant="ghost"`, `size="icon"`
    - Menu items (per research discretion recommendation -- table quick actions):
      - "View Details" -- navigates to `/users/{user.id}` using next-intl router
      - Separator
      - If user.isActive: "Deactivate" -- opens ConfirmActionDialog
      - If !user.isActive: "Reactivate" -- opens ConfirmActionDialog
      - "Reset Password" -- opens ConfirmActionDialog, on confirm calls resetUserPassword, on success opens ResetTokenDialog with the token
      - Separator (only if destructive items present)

    State management:
    - `confirmAction: "deactivate" | "reactivate" | "reset" | null` -- which confirmation dialog is open
    - `resetToken: CredentialResetResponse | null` -- when reset token dialog should show
    - `loading: boolean` -- action in progress

    On confirm deactivate: call `deactivateUser(user.id)`, show toast on success/error
    On confirm reactivate: call `reactivateUser(user.id)`, show toast on success/error
    On confirm reset: call `resetUserPassword(user.id)`, show toast, show ResetTokenDialog with result

    Use useTranslations("users") for all labels.

    **4. Update `web/src/app/[locale]/users/_components/columns.tsx`** -- replace the placeholder actions column:

    Import `UserActions` from `./user-actions`. The Actions column cell should render `<UserActions user={row.original} />`. If the actions column was already rendering a placeholder, replace it with the real component.

    Also stop propagation on the actions cell click to prevent row click navigation when interacting with the dropdown: wrap the cell in a `<div onClick={(e) => e.stopPropagation()}>`.
  </action>
  <verify>
    test -f web/src/app/\[locale\]/users/_components/user-actions.tsx && echo "user-actions.tsx exists"
    test -f web/src/app/\[locale\]/users/_components/confirm-action-dialog.tsx && echo "confirm-action-dialog.tsx exists"
    test -f web/src/app/\[locale\]/users/_components/reset-token-dialog.tsx && echo "reset-token-dialog.tsx exists"
    cd web && npx tsc --noEmit 2>&1 | head -10
  </verify>
  <done>UserActions dropdown renders in each table row with View Details, Deactivate/Reactivate, Reset Password. Each destructive action opens a confirmation dialog. Password reset shows the credential token in a dialog with copy button. Actions column click does not trigger row navigation.</done>
</task>

<task type="auto">
  <name>Task 2: User detail page and edit roles dialog</name>
  <files>
    web/src/app/[locale]/users/[id]/page.tsx
    web/src/app/[locale]/users/_components/edit-roles-dialog.tsx
  </files>
  <action>
    **1. Create `web/src/app/[locale]/users/_components/edit-roles-dialog.tsx`** -- dialog for editing user roles:

    "use client" directive. Props:
    - `open: boolean`
    - `onOpenChange: (open: boolean) => void`
    - `userId: string`
    - `currentRoles: string[]`

    Uses shadcn Dialog with form content:
    - Title: "Edit Roles" (translated)
    - 4 checkboxes, one for each role: admin, project_manager, engineer, field_worker
    - Pre-checked based on `currentRoles` prop
    - Uses react-hook-form + zod: roles array must have at least 1 item
    - On submit: calls `updateUserRoles(userId, { roles: selectedRoles })`
    - Toast on success/error
    - Closes dialog on success
    - Each role checkbox shows the translated role label from the "roles" translation namespace (roles.admin, roles.project_manager, etc.)

    **2. Create `web/src/app/[locale]/users/[id]/page.tsx`** -- user detail page:

    Server Component. Params: `{ locale: string, id: string }`.

    - Check auth + admin role (same pattern as users list page)
    - Fetch user: `const user = await apiFetch<UserOut>(`/users/${id}`)`
    - Map snake_case to camelCase UserRow
    - Also fetch last login from the user data

    Layout (per CONTEXT.md locked decision -- detail page shows profile data, roles, status, actions, projects placeholder):

    Page header: Back button (arrow left + "Back to users" link), user display name as h1, status badge.

    Content in 2-column grid (lg:grid-cols-3, first column spans 2):

    **Left column (lg:col-span-2):**

    Card 1 - Profile Information:
    - Display name, Username, Email, Phone (or "Not set")
    - Each as a labeled field in a 2-column grid
    - Use muted labels + regular value text

    Card 2 - Roles:
    - Show current roles as Badge components
    - "Edit Roles" button (opens EditRolesDialog)

    **Right column (lg:col-span-1):**

    Card 3 - Actions:
    - If active: "Deactivate User" button (destructive variant) with ConfirmActionDialog
    - If inactive: "Reactivate User" button with ConfirmActionDialog
    - "Reset Password" button with ConfirmActionDialog + ResetTokenDialog
    - Each button is full-width, stacked vertically with gap

    Card 4 - Projects (placeholder per CONTEXT.md):
    - Title: "Assigned Projects"
    - Content: muted text "Projects will be available after Phase 3" (translated: users.projectsPlaceholder)
    - This is a placeholder for Phase 3 project assignment feature

    Card 5 - Account Info:
    - Status: Active/Inactive badge
    - Last Login: formatted date or "Never"
    - User ID (UUID): muted small text

    All strings use translations from "users" namespace. The detail page reuses ConfirmActionDialog, ResetTokenDialog, and EditRolesDialog from the _components directory. Import server actions from _actions.ts for the action buttons.

    Note: Since actions require client-side interactivity (dialogs, state), extract the action buttons section into a small client component `UserDetailActions` within the same file (or inline "use client" component). The page itself stays as a Server Component for data fetching. Pass the user data to the client component as props.
  </action>
  <verify>
    test -f web/src/app/\[locale\]/users/\[id\]/page.tsx && echo "Detail page exists"
    test -f web/src/app/\[locale\]/users/_components/edit-roles-dialog.tsx && echo "edit-roles-dialog.tsx exists"
    cd web && npx tsc --noEmit 2>&1 | head -10
    cd web && npm run build 2>&1 | tail -20
  </verify>
  <done>User detail page at /users/[id] shows profile data, roles with edit dialog, status, action buttons (deactivate/reactivate, reset password), and projects placeholder section. Edit Roles dialog allows changing role assignments via checkboxes. All actions trigger confirmation dialogs and show toast feedback.</done>
</task>

</tasks>

<verification>
1. `cd web && npx tsc --noEmit` -- zero TypeScript errors
2. `cd web && npm run build` -- build succeeds with all routes compiled
3. Table actions dropdown shows View Details, Deactivate/Reactivate, Reset Password
4. Clicking a table row navigates to /users/[id]
5. Detail page renders profile info, roles, actions, projects placeholder
6. Edit Roles dialog opens with checkboxes pre-checked
7. Confirmation dialogs appear before destructive actions
8. Reset token dialog shows token with copy button
</verification>

<success_criteria>
- Table rows have working actions dropdown with all operations
- /users/[id] detail page shows complete user profile with all sections
- Deactivate/Reactivate toggles user status with confirmation
- Role changes update via edit dialog with checkboxes
- Password reset generates and displays credential token
- All destructive actions require confirmation dialog
- Toast notifications for all operation outcomes
- Projects placeholder section visible on detail page
- All UI strings bilingual (BG/EN)
</success_criteria>

<output>
After completion, create `.planning/phases/02-user-management/02-03-SUMMARY.md`
</output>
