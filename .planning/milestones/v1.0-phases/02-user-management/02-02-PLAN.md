---
phase: 02-user-management
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - web/package.json
  - web/src/components/ui/table.tsx
  - web/src/components/ui/dialog.tsx
  - web/src/components/ui/alert-dialog.tsx
  - web/src/components/ui/form.tsx
  - web/src/components/ui/label.tsx
  - web/src/components/ui/select.tsx
  - web/src/components/ui/sonner.tsx
  - web/src/components/ui/dropdown-menu.tsx
  - web/src/components/ui/checkbox.tsx
  - web/src/types/user.ts
  - web/src/app/[locale]/users/page.tsx
  - web/src/app/[locale]/users/_components/columns.tsx
  - web/src/app/[locale]/users/_components/data-table.tsx
  - web/src/app/[locale]/users/_components/data-table-toolbar.tsx
  - web/src/app/[locale]/users/_components/create-user-dialog.tsx
  - web/src/app/[locale]/users/_actions.ts
  - web/src/lib/api.ts
  - web/src/messages/en.json
  - web/src/messages/bg.json
  - web/src/app/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view a paginated data table of all users with Name, Email, Role badges, Status badge, Last Login, and Actions columns"
    - "Text search filters table rows by name or email"
    - "Dropdown filters allow filtering by role and by active/inactive status"
    - "Deactivated users show dimmed row with red Inactive badge"
    - "Admin can open a Create User modal dialog from a button above the table"
    - "Create User form has fields: Username, Display Name, Email, Phone (optional), Role(s) with multi-select"
    - "After creating a user, a credential reset token is displayed for the admin to share"
  artifacts:
    - path: "web/src/app/[locale]/users/page.tsx"
      provides: "Server component that fetches users and renders data table"
      min_lines: 20
    - path: "web/src/app/[locale]/users/_components/data-table.tsx"
      provides: "Client component wrapping TanStack React Table"
      min_lines: 40
    - path: "web/src/app/[locale]/users/_components/columns.tsx"
      provides: "Column definitions for the user data table"
      contains: "ColumnDef"
    - path: "web/src/app/[locale]/users/_components/create-user-dialog.tsx"
      provides: "Modal dialog form for creating new users"
      contains: "CreateUserDialog"
    - path: "web/src/app/[locale]/users/_actions.ts"
      provides: "Server Actions for user CRUD operations"
      contains: "use server"
    - path: "web/src/types/user.ts"
      provides: "TypeScript types for user data"
      contains: "UserRow"
  key_links:
    - from: "web/src/app/[locale]/users/page.tsx"
      to: "web/src/lib/api.ts"
      via: "apiFetch to load users"
      pattern: "apiFetch.*users"
    - from: "web/src/app/[locale]/users/_actions.ts"
      to: "web/src/lib/api.ts"
      via: "apiFetch for mutations"
      pattern: "apiFetch.*users"
    - from: "web/src/app/[locale]/users/_components/data-table.tsx"
      to: "web/src/app/[locale]/users/_components/columns.tsx"
      via: "columns prop"
      pattern: "columns"
    - from: "web/src/app/[locale]/users/_components/create-user-dialog.tsx"
      to: "web/src/app/[locale]/users/_actions.ts"
      via: "createUser server action"
      pattern: "createUser"
---

<objective>
Build the user list page with a TanStack React Table data table showing all users, text search, role/status filters, pagination, and a Create User modal dialog with credential reset token display.

Purpose: This is the primary admin interface for viewing and creating users -- the two most fundamental operations. The data-dense table with filters matches the Phase 1 UI style. The create flow includes Kanidm credential reset token display since Kanidm does not support email invites.

Output: Working /users page with filterable data table and create user dialog. Replaces the Phase 1 placeholder page.
</objective>

<execution_context>
@/home/rosen/.claude/get-shit-done/workflows/execute-plan.md
@/home/rosen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-user-management/02-RESEARCH.md
@.planning/phases/02-user-management/02-CONTEXT.md
@.planning/phases/02-user-management/02-01-SUMMARY.md
@web/src/app/[locale]/users/page.tsx
@web/src/lib/api.ts
@web/src/lib/roles.ts
@web/src/messages/en.json
@web/src/messages/bg.json
@web/src/auth.ts
@web/src/app/[locale]/layout.tsx
@web/src/app/layout.tsx
@web/src/components/providers.tsx
@web/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies, shadcn/ui components, types, and Sonner provider</name>
  <files>
    web/package.json
    web/src/components/ui/table.tsx
    web/src/components/ui/dialog.tsx
    web/src/components/ui/alert-dialog.tsx
    web/src/components/ui/form.tsx
    web/src/components/ui/label.tsx
    web/src/components/ui/select.tsx
    web/src/components/ui/sonner.tsx
    web/src/components/ui/checkbox.tsx
    web/src/types/user.ts
    web/src/app/layout.tsx
  </files>
  <action>
    **1. Install npm dependencies** (run from web/ directory):
    ```bash
    npm install @tanstack/react-table sonner zod react-hook-form @hookform/resolvers
    ```

    **2. Add shadcn/ui components** (run from web/ directory):
    ```bash
    npx shadcn@latest add table dialog alert-dialog form label select sonner dropdown-menu checkbox
    ```

    Note: badge, button, input are already installed from Phase 1. dropdown-menu is also already installed but include it in case the CLI skips duplicates gracefully.

    **3. Create `web/src/types/user.ts`** -- shared TypeScript types:

    ```typescript
    export type UserRow = {
      id: string;
      username: string;
      displayName: string;
      email: string;
      phone: string | null;
      roles: string[];
      isActive: boolean;
      lastLogin: string | null;
    };

    export type UserListResponse = {
      users: UserRow[];
    };

    export type CreateUserInput = {
      username: string;
      display_name: string;
      email: string;
      phone?: string;
      roles: string[];
    };

    export type CredentialResetResponse = {
      token: string;
      ttl: number;
      reset_url: string;
    };

    export type UserRoleUpdateInput = {
      roles: string[];
    };
    ```

    Note: Field names in CreateUserInput use snake_case to match the FastAPI Pydantic model. The UserRow uses camelCase for frontend convention -- the server action will map between them.

    **4. Add Sonner Toaster to the root layout** -- update `web/src/app/layout.tsx` to include the Sonner `<Toaster />` component. Import `{ Toaster }` from `"@/components/ui/sonner"` and place it just before the closing `</body>` tag, OUTSIDE of any provider wrapper. The Toaster is a global component that does not need session or theme context to render (Sonner handles its own theming). Do NOT modify the Providers component or the locale layout.
  </action>
  <verify>
    cd web && npx tsc --noEmit 2>&1 | head -5
    node -e "require('@tanstack/react-table'); require('sonner'); require('zod'); require('react-hook-form'); console.log('All deps OK')"
  </verify>
  <done>@tanstack/react-table, sonner, zod, react-hook-form, @hookform/resolvers installed. All required shadcn/ui components present. UserRow and related types defined. Sonner Toaster in root layout.</done>
</task>

<task type="auto">
  <name>Task 2: User list page with data table, search/filters, create dialog, and server actions</name>
  <files>
    web/src/app/[locale]/users/page.tsx
    web/src/app/[locale]/users/_components/columns.tsx
    web/src/app/[locale]/users/_components/data-table.tsx
    web/src/app/[locale]/users/_components/data-table-toolbar.tsx
    web/src/app/[locale]/users/_components/create-user-dialog.tsx
    web/src/app/[locale]/users/_actions.ts
    web/src/lib/api.ts
    web/src/messages/en.json
    web/src/messages/bg.json
  </files>
  <action>
    **1. Create `web/src/app/[locale]/users/_actions.ts`** -- Server Actions for all user operations:

    ```typescript
    "use server";
    import { apiFetch } from "@/lib/api";
    import { revalidatePath } from "next/cache";
    import type { CreateUserInput, CredentialResetResponse, UserRoleUpdateInput } from "@/types/user";
    ```

    Server Actions (all call apiFetch which adds the Bearer token):
    - `createUser(data: CreateUserInput): Promise<CredentialResetResponse>` -- POST /users, revalidatePath("/[locale]/users"), return result
    - `deactivateUser(userId: string): Promise<void>` -- POST /users/{userId}/deactivate, revalidatePath
    - `reactivateUser(userId: string): Promise<void>` -- POST /users/{userId}/reactivate, revalidatePath
    - `updateUserRoles(userId: string, data: UserRoleUpdateInput): Promise<void>` -- PUT /users/{userId}/roles, revalidatePath
    - `resetUserPassword(userId: string): Promise<CredentialResetResponse>` -- POST /users/{userId}/reset-password, return result

    Each action wraps in try/catch and returns `{ error: string }` on failure, or the result on success. Use a discriminated union pattern: `{ success: true, data: T } | { success: false, error: string }`.

    **2. Update `web/src/lib/api.ts`** -- the existing apiFetch is fine for GET, but ensure it handles non-JSON responses gracefully. Add an overload or modify so that when the response has no body (204), it returns `undefined` instead of trying to parse JSON. Check the current implementation and make minimal changes.

    **3. Create `web/src/app/[locale]/users/_components/columns.tsx`** -- TanStack column definitions:

    "use client" directive. Import ColumnDef from @tanstack/react-table, Badge from shadcn, UserRow type.

    Columns (per CONTEXT.md locked decision):
    - **Name (displayName)**: Sortable. Cell renders with `opacity-50` class when `!row.original.isActive`. Show username in smaller muted text below display name.
    - **Email**: Sortable. Also dimmed when inactive.
    - **Role(s)**: Cell renders array of `<Badge variant="secondary">` for each role. Use translated role names if possible (pass translation function), otherwise use the role key capitalized.
    - **Status (isActive)**: Cell renders `<Badge variant="default">Active</Badge>` or `<Badge variant="destructive">Inactive</Badge>` per locked decision (red badge for inactive).
    - **Last Login**: Formatted date/time or "-" if null. Use `toLocaleDateString` + `toLocaleTimeString` with locale from the page.
    - **Actions**: An actions column (id: "actions", no header) rendering `<UserActions user={row.original} />` component -- create a placeholder for now, the real actions component comes in Plan 03.

    Export `columns` as a function that receives translations `t` (for header labels) and returns `ColumnDef<UserRow>[]`. This allows bilingual headers.

    **4. Create `web/src/app/[locale]/users/_components/data-table.tsx`** -- reusable data table wrapper:

    "use client" directive. Props: `columns: ColumnDef<UserRow>[]`, `data: UserRow[]`.

    Use @tanstack/react-table:
    - `useReactTable` with `getCoreRowModel`, `getPaginationRowModel`, `getSortedRowModel`, `getFilteredRowModel`
    - State: `sorting`, `columnFilters`, `globalFilter`
    - Render using shadcn `<Table>`, `<TableHeader>`, `<TableRow>`, `<TableHead>`, `<TableBody>`, `<TableCell>`
    - Pagination controls at the bottom: Previous/Next buttons + page info text + page size selector (10/20/50)
    - Row className: apply `opacity-60 bg-muted/30` when the row's original.isActive is false (dimmed row per locked decision)
    - Row onClick: navigate to `/users/{row.original.id}` using next-intl's `useRouter` (row click goes to detail page per locked decision)
    - cursor-pointer on rows

    Accept `toolbar` as a ReactNode prop to render above the table (for search/filter/create button).

    **5. Create `web/src/app/[locale]/users/_components/data-table-toolbar.tsx`** -- search and filter controls:

    "use client" directive. Props: `table: Table<UserRow>`.

    Layout: flex row with gap, items centered.
    - **Text search input**: `<Input placeholder={t("searchPlaceholder")} />` that sets `table.setGlobalFilter(value)`. Filters by name AND email (global filter).
    - **Role filter**: `<Select>` dropdown with options: All, Admin, Project Manager, Engineer, Field Worker. On change, set column filter on "roles" column.
    - **Status filter**: `<Select>` dropdown with options: All, Active, Inactive. On change, set column filter on "isActive" column.

    Accept `createButton` as ReactNode prop to render at the end of the toolbar (right-aligned with `ml-auto`).

    **6. Create `web/src/app/[locale]/users/_components/create-user-dialog.tsx`** -- modal form for creating users:

    "use client" directive. Uses react-hook-form + zodResolver + shadcn Form.

    Zod schema:
    - username: z.string().min(2, "...").max(64)
    - displayName: z.string().min(1).max(256)
    - email: z.string().email()
    - phone: z.string().optional().or(z.literal(""))
    - roles: z.array(z.string()).min(1, "At least one role required")

    Form fields using shadcn FormField/FormItem/FormLabel/FormControl/FormMessage:
    - Username: Input
    - Display Name: Input
    - Email: Input type="email"
    - Phone: Input type="tel" (optional)
    - Roles: Checkboxes (not a select dropdown) for each of the 4 roles: admin, project_manager, engineer, field_worker. Use Checkbox component from shadcn. Multiple roles can be selected per locked decision.

    On submit: call `createUser` server action. On success: show toast via sonner, then display the credential reset token in the same dialog (switch to a "success" view showing the token + copy button + reset URL). On error: show toast with error message.

    Dialog trigger: `<Button>` with Plus icon + text from translations. Dialog controlled by open/onOpenChange state.

    After showing the reset token, a "Close" button dismisses the dialog and the form resets.

    **7. Replace `web/src/app/[locale]/users/page.tsx`** -- Server Component:

    This replaces the Phase 1 placeholder page completely.

    - Import auth, check admin role (keep existing pattern: `if (!session.user.roles.includes("admin")) notFound()`)
    - Fetch users: `const data = await apiFetch<UserListResponse>("/users")`
    - Map snake_case response to camelCase UserRow[] (id, username, display_name -> displayName, email, is_active -> isActive, last_login -> lastLogin, roles, phone)
    - Render: page title `<h1>` with translation, then `<DataTable>` with `<DataTableToolbar>` (containing `<CreateUserDialog>`) as toolbar prop
    - Pass columns (from columns.tsx with translations) and mapped data to DataTable

    **8. Update translation files** -- add `users.*` keys to both `web/src/messages/en.json` and `web/src/messages/bg.json`:

    ```json
    // en.json additions under "users" key:
    {
      "users": {
        "title": "User Management",
        "searchPlaceholder": "Search by name or email...",
        "filterRole": "All Roles",
        "filterStatus": "All Statuses",
        "statusActive": "Active",
        "statusInactive": "Inactive",
        "name": "Name",
        "email": "Email",
        "role": "Role",
        "status": "Status",
        "lastLogin": "Last Login",
        "actions": "Actions",
        "never": "Never",
        "createUser": "New User",
        "createTitle": "Create New User",
        "username": "Username",
        "displayName": "Display Name",
        "phone": "Phone",
        "phoneOptional": "Phone (optional)",
        "selectRoles": "Select roles",
        "create": "Create",
        "cancel": "Cancel",
        "creating": "Creating...",
        "createSuccess": "User created successfully",
        "createError": "Failed to create user",
        "resetTokenTitle": "Credential Reset Token",
        "resetTokenDescription": "Share this token with the user. They must visit the link below and enter this token to set their password.",
        "resetToken": "Token",
        "resetUrl": "Reset URL",
        "copyToken": "Copy Token",
        "copied": "Copied!",
        "close": "Close",
        "validFor": "Valid for {minutes} minutes",
        "showing": "Showing {from}-{to} of {total} users",
        "previous": "Previous",
        "next": "Next",
        "rowsPerPage": "Rows per page",
        "deactivate": "Deactivate",
        "reactivate": "Reactivate",
        "resetPassword": "Reset Password",
        "editRoles": "Edit Roles",
        "viewDetails": "View Details",
        "confirmDeactivateTitle": "Deactivate User",
        "confirmDeactivateDescription": "Are you sure you want to deactivate {name}? They will no longer be able to log in.",
        "confirmReactivateTitle": "Reactivate User",
        "confirmReactivateDescription": "Are you sure you want to reactivate {name}? They will be able to log in again.",
        "confirmResetTitle": "Reset Password",
        "confirmResetDescription": "Generate a new credential reset token for {name}?",
        "deactivateSuccess": "User deactivated",
        "reactivateSuccess": "User reactivated",
        "resetSuccess": "Password reset token generated",
        "actionError": "Operation failed",
        "rolesUpdated": "Roles updated successfully",
        "projectsPlaceholder": "Projects will be available after Phase 3"
      }
    }
    ```

    Bulgarian translations (same keys):
    ```json
    {
      "users": {
        "title": "Управление на потребители",
        "searchPlaceholder": "Търсене по име или email...",
        "filterRole": "Всички роли",
        "filterStatus": "Всички статуси",
        "statusActive": "Активен",
        "statusInactive": "Неактивен",
        "name": "Име",
        "email": "Email",
        "role": "Роля",
        "status": "Статус",
        "lastLogin": "Последно влизане",
        "actions": "Действия",
        "never": "Никога",
        "createUser": "Нов потребител",
        "createTitle": "Създаване на нов потребител",
        "username": "Потребителско име",
        "displayName": "Показвано име",
        "phone": "Телефон",
        "phoneOptional": "Телефон (по избор)",
        "selectRoles": "Изберете роли",
        "create": "Създай",
        "cancel": "Отказ",
        "creating": "Създаване...",
        "createSuccess": "Потребителят е създаден успешно",
        "createError": "Грешка при създаване на потребител",
        "resetTokenTitle": "Токен за смяна на парола",
        "resetTokenDescription": "Споделете този токен с потребителя. Той трябва да посети линка по-долу и да въведе токена, за да зададе паролата си.",
        "resetToken": "Токен",
        "resetUrl": "URL за смяна",
        "copyToken": "Копирай токен",
        "copied": "Копирано!",
        "close": "Затвори",
        "validFor": "Валиден за {minutes} минути",
        "showing": "Показване {from}-{to} от {total} потребители",
        "previous": "Предишна",
        "next": "Следваща",
        "rowsPerPage": "Редове на страница",
        "deactivate": "Деактивирай",
        "reactivate": "Реактивирай",
        "resetPassword": "Смяна на парола",
        "editRoles": "Промяна на роли",
        "viewDetails": "Подробности",
        "confirmDeactivateTitle": "Деактивиране на потребител",
        "confirmDeactivateDescription": "Сигурни ли сте, че искате да деактивирате {name}? Той/тя няма да може да влиза.",
        "confirmReactivateTitle": "Реактивиране на потребител",
        "confirmReactivateDescription": "Сигурни ли сте, че искате да реактивирате {name}? Той/тя ще може отново да влиза.",
        "confirmResetTitle": "Смяна на парола",
        "confirmResetDescription": "Генериране на нов токен за смяна на парола за {name}?",
        "deactivateSuccess": "Потребителят е деактивиран",
        "reactivateSuccess": "Потребителят е реактивиран",
        "resetSuccess": "Генериран е токен за смяна на парола",
        "actionError": "Операцията не успя",
        "rolesUpdated": "Ролите са обновени успешно",
        "projectsPlaceholder": "Проектите ще бъдат налични след Phase 3"
      }
    }
    ```

    Merge these into the existing en.json and bg.json files alongside the existing keys (nav, profile, placeholder, common, auth, roles). Do NOT remove any existing keys.
  </action>
  <verify>
    cd web && npx tsc --noEmit 2>&1 | head -10
    test -f web/src/app/\[locale\]/users/_actions.ts && echo "_actions.ts exists"
    test -f web/src/app/\[locale\]/users/_components/data-table.tsx && echo "data-table.tsx exists"
    test -f web/src/app/\[locale\]/users/_components/columns.tsx && echo "columns.tsx exists"
    test -f web/src/app/\[locale\]/users/_components/create-user-dialog.tsx && echo "create-user-dialog.tsx exists"
  </verify>
  <done>User list page renders data table with Name, Email, Role, Status, Last Login, Actions columns. Text search + role/status filters work. Create User dialog opens, submits form, displays credential reset token on success. All strings bilingual (BG/EN). Inactive users show dimmed rows with red badge.</done>
</task>

</tasks>

<verification>
1. `cd web && npx tsc --noEmit` -- zero TypeScript errors
2. `cd web && npm run build` -- build succeeds
3. Users page at /en/users renders a data table (not the Phase 1 placeholder)
4. Create User dialog opens and validates form inputs
5. All translation keys present in en.json and bg.json
6. Sonner Toaster component rendered in root layout
</verification>

<success_criteria>
- /users page shows a data-dense table with 6 columns matching CONTEXT.md decisions
- Text search filters by name/email
- Role and status dropdown filters work
- Pagination with 20 rows/page default, page size selector (10/20/50)
- Inactive users: dimmed row + red "Inactive"/"Neaktiven" badge
- Create User modal: Username, Display Name, Email, Phone, Role checkboxes
- After create: credential reset token displayed with copy button
- All UI strings translated in BG and EN
- Row click navigates to /users/[id] (detail page, built in Plan 03)
</success_criteria>

<output>
After completion, create `.planning/phases/02-user-management/02-02-SUMMARY.md`
</output>
